var ht=Object.defineProperty,dt=Object.defineProperties;var ct=Object.getOwnPropertyDescriptors;var _e=Object.getOwnPropertySymbols;var pt=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable;var Fe=(e,t,i)=>t in e?ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,I=(e,t)=>{for(var i in t||(t={}))pt.call(t,i)&&Fe(e,i,t[i]);if(_e)for(var i of _e(t))mt.call(t,i)&&Fe(e,i,t[i]);return e},ve=(e,t)=>dt(e,ct(t));import{t as y,b4 as fe,ad as ft,hL as gt,hM as xe,cm as Ee,dJ as yt,r as c,e5 as _t,ba as Te,hN as Ft,Z as R,hO as vt,a8 as ge,e as o,d as l,n as q,y as qe,u as Ge,an as xt,ax as Et,az as ze,b as M,aY as ae,A as S,aC as He,dX as Tt,aD as bt,hP as Rt,hQ as wt,bc as Ct,D as ne,hR as Dt,hS as ke,hT as St,hU as Ot,b3 as Mt,hV as Pt,O as H,T as k,v as $t,g as Y,h as It,j as Nt,eF as At,c as Vt,E as be,P as N,I as P,aA as Ut,aK as Be,q as O,U as B,dZ as Lt,hW as qt,hX as Gt,cu as Re,e7 as zt,a3 as we,e8 as je,e9 as Ht,dL as x,ei as W,ee as w,eh as oe,eo as le,eq as Qe,ep as kt,er as We,hY as ue,hZ as $,h_ as Xe,h$ as he,i0 as A,bA as de,i1 as Ze,es as Ke,et as Ye,eu as Je,em as Bt,i2 as jt,en as Ce,eA as et,i3 as V,i4 as Qt,dM as Wt,dP as Xt,i5 as Zt,i6 as Kt,i7 as Yt,i8 as Jt,dV as ei,i9 as ti,ia as ii,ib as si,ic as ri,ce as ai,id as ni,ie as oi,ig as li,ih as ui,ii as hi,gb as di,ij as ci,ik as pi,f as mi,k as tt,i as fi,L as gi,F as it,il as yi,im as De,bI as L,io as _i,ip as Fi,a0 as vi,iq as Se,$ as Oe,ir as xi,e0 as Me,is as Ei,it as Ti,e3 as bi,dK as Ri,iu as wi,ag as Ci,gD as Di,aj as Si,B as Oi,aI as j}from"./index.25dca4c3.js";import{l as Mi,I as Pi}from"./Graphics3DFeatureProcessor.a874bce4.js";import{m as $i}from"./FeatureStore.cd603f50.js";import{f as Ii,n as Ni}from"./heatmapUtils.870250d0.js";import{l as Ai}from"./projectExtentUtils.a4abbe1e.js";function st(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const s=e[i],r=t[i];if(s.length!==r.length)return!1;for(let a=0;a<s.length;a++)if(s[a]!==r[a])return!1}return!0}function rt(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!st(e[i],t[i]))return!1;return!0}function Vi(e,t){return!!G(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function Ui(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!G(e.spatialReference,t.spatialReference)&&rt(e.paths,t.paths)}function Li(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!G(e.spatialReference,t.spatialReference)&&rt(e.rings,t.rings)}function qi(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!G(e.spatialReference,t.spatialReference)&&st(e.points,t.points)}function Gi(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!G(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}function G(e,t){return e===t||e&&t&&e.equals(t)}function zi(e,t){if(e===t)return!0;if(y(e)||y(t)||e.type!==t.type)return!1;switch(e.type){case"point":return Vi(e,t);case"extent":return Gi(e,t);case"polyline":return Ui(e,t);case"polygon":return Li(e,t);case"multipoint":return qi(e,t);case"mesh":return!1;default:return}}function Hi(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(const r of i)if(e[r]!==t[r])return!1;return!0}function at(e,t){return e===t||e!=null&&t!=null&&e.objectId===t.objectId&&!!zi(e.geometry,t.geometry)&&!!Hi(e.attributes,t.attributes)}class ki{constructor(t,i){this.highestResolutionVersion=null,this.versions=[],this.ref(t,i)}get isReferenced(){return this.versions.length!==0}get isSingle(){return this.versions.length===1&&this.versions[0].refCount===1}ref(t,i){const s=this.feature;v.oldVersion=s,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0});for(const a of this.versions)if(a.resolution===i){a.refCount++;const n=this.highestResolutionVersion===a&&!at(t,a.feature);return(n||this.highestResolutionVersion!==a)&&(a.feature=t),v.newVersion=n?t:s,v}const r={feature:t,resolution:i,refCount:1};return this.versions.push(r),!this.highestResolutionVersion||i<this.highestResolutionVersion.resolution?(v.newVersion=t,this.highestResolutionVersion=r):v.newVersion=s,v}unref(t){for(let i=0;i<this.versions.length;i++){const s=this.versions[i];if(s.resolution===t)return s.refCount--,v.oldVersion=this.feature,s.refCount===0&&(this.versions[i]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===s&&(this._recalculateHighestResolutionVersion(),v.oldVersion=s.feature)),v.newVersion=this.feature,v}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(this.versions.length===0)return void(this.highestResolutionVersion=null);let t=this.versions[0];for(let i=1;i<this.versions.length;i++){const s=this.versions[i];s.resolution<t.resolution&&(t=s)}this.highestResolutionVersion=t}}class Bi{constructor(t){this._feature=t,this.refCount=1}get isReferenced(){return this.refCount!==0}get isSingle(){return this.refCount===1}ref(t){return++this.refCount,v.oldVersion=this._feature,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0}),at(this._feature,t)||(this._feature=t),v.newVersion=this._feature,v}unref(){return v.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(v.newVersion=null,v):(v.newVersion=this._feature,v)}get feature(){return this._feature}}const v={oldVersion:null,newVersion:null},ji=16438,Pe=new Set;class Qi{constructor(t){this.descriptor=t,this.fetchStatus=f.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=J,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Pe,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(t,i,s){this._availableFields=ft(s,Pe),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=i/(t.length+i),this._numVertices=t.reduce((r,a)=>r+gt(a.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>J}get needsFeatureCount(){return this._numFeatures===J}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const i=xe(this._features[t]);this._estimatedSize+=i,t>=this.featureLimit&&(this._estimatedUnusedSize+=i)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=xe(this._features[t]);return!0}return!1}get isFetching(){return this.fetchStatus===f.FETCHING||this.fetchStatus===f.REFETCHING}get isRefetching(){return this.fetchStatus===f.REFETCHING}get needsFetching(){return this.fetchStatus===f.FETCH_NEEDED||this.fetchStatus===f.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===f.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===f.DONE||this.fetchStatus===f.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===f.REFETCHING?f.REFETCH_NEEDED:f.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!Xi(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||(Ee(t,$e),yt(this.descriptor.extent,$e))}intersectionIncludingBorrowed(t,i){const s=c(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||s?(t?(Ee(t,i),_t(i,s,i)):Te(i,s),i):(Te(i,Ft),i)}_shuffle(t){this._features.sort((i,s)=>R(i,t)-R(s,t)),vt(this._features,ji),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,i,s){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===f.DONE&&this._features.length>0&&(this.fetchStatus=f.REFETCH_NEEDED,r=!0)),!this._shuffled&&t<1&&this._shuffle(s);const a=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>a&&(this._features.length=a,this.featuresMissing=!0,this.fetchStatus===f.FULL&&(this.fetchStatus=f.DONE)),r}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const J=-1,Wi=-2;var f;function Xi(e,t,i){if(y(t)||y(e)||i!==t.length||i>e.length)return!1;for(let s=0;s<i;++s)if(e[s]!==t[s])return!1;return!0}(function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"})(f||(f={}));const $e=fe(),ee=ge.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let F=class extends qe{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new Ge,this._frameTask=xt,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&c(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this.featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.numFeatures),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void ee.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}initialize(){this.handles.add(Et(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?ki:Bi;const e=this.context.scheduler;c(e)&&(this._frameTask=e.registerTask(ze.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this.handles=M(this.handles),this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),c(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),c(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this.suspended||(this.suspended=!0,this._pause(),this._setDirty())}resume(){this.suspended&&(this.suspended=!1,this._unpause())}_pause(){this.paused&&(this.featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this.paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this.featureTiles.forEach(t=>{y(t.displayingFeatures)||t.displayingFeatures.length===0||(y(e)?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields.has(i)||ae(e).delete(i)}))}),c(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this.pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(s=>{if(S(s))throw s;return null}).then(s=>s&&(this._applyEditsDeleteFeatures(s.deletedFeatures),this._applyEditsAddUpdateFeatures(s.addedFeatures,s.updatedFeatures,t.controller.signal).then(()=>s))).then(s=>(--t.count==0&&(this.pendingEdits===t&&(this.pendingEdits=null),c(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),s)));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(e.length===0)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),s=new Set,r=this.objectIdField;e.forEach(({objectId:a,globalId:n})=>{if((!a||a<0)&&t){i||ee.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const u=this.features.find(d=>d.attributes&&d.attributes[t]===n);u&&s.add(R(u,r))}else s.add(a)}),this.featureTiles.forEach(a=>{if(!a.features)return;const n=a.features.filter(u=>!s.has(R(u,this.objectIdField)));n.length!==a.features.length&&(a.setFeatures(n,0,a.availableFields),this._invalidateCounts())})}async _applyEditsAddUpdateFeatures(e,t,i){const s=[],r=new Set;if(e.forEach(n=>s.push(n.objectId)),t.forEach(n=>{s.push(n.objectId),r.add(n.objectId)}),s.length===0)return;const a=[];this.featureTiles.forEach(n=>{const u=this._applyEditsAddUpdateTile(n,s,r,i);u&&a.push(u)}),await He(a)}async _applyEditsAddUpdateTile(e,t,i,s){if(!e.features)return;const r=this._createQuery(e);r.resultType=void 0,r.cacheHint=!1,r.objectIds=t;const a=await this._queryFeatures(r,s);let n=null;if(i.size>0){const u=e.features.filter(d=>!i.has(R(d,this.objectIdField)));u.length!==e.features.length&&(n=u)}if(a.features.length>0){n||(n=e.features.slice());for(const u of a.features)n.push(u)}n&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,n.length)),e.setFeatures(n,0,Ie(e.availableFields,a.fields)),this._invalidateCounts())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:es})}_setDirty(){this._dirty=!0,this._updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this._getListOfTiles();if(this._markTilesNotAlive(t),!e.run(()=>this._addTiles(t,e))||!e.run(()=>this._filterExtentTiles(t,e))||!e.run(()=>this._removeTiles(t,e))||e.done)return void this._setDirty();const i=this._sortTiles(t);e.run(()=>this._displayTiles(i,e))&&e.run(()=>this._fetchTiles(i,e))&&e.run(()=>this._updateMemoryEstimates(i,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach(i=>{const s=this.featureTiles.get(i.id);s?s.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const s=e[i];s.alive||(this._removeTile(s),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((t,i)=>t.descriptor.loadPriority-i.descriptor.loadPriority),e}_displayTiles(e,t){const i=this._updateRatio(e),s=r=>{const a=this._fullRatio<1?i(r)*this._farRatio:1;return r.reduceFeatures(a,this.memoryFactor,this.objectIdField)&&this._setDirty(),this._showTile(r)};for(const r of e)if(!t.run(()=>s(r))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const s of e){if(!s.needsFetching)continue;const r=c(this.context.memoryCache)?this.context.memoryCache.pop(s.id):null;if(c(r))s.cache=r,this._setDirty(),this._scheduleUpdated(),t.madeProgress();else{if(this._needsNumFeatures(s)){const a=new AbortController,n=this._fetchTileCount(s,a.signal);this._handleRequest(s,n,a,()=>s.numFeatures=Wi),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const s of e)if(s.needsFetching){const r=new AbortController,a=this._fetchTile(s,r.signal);if(this._handleRequest(s,a,r,n=>{s.setFeatures([],0,null),this._invalidateCounts(),s.featuresMissing=!1,this.context.logFetchError(ee,n)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(i=>!t.run(()=>i.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach(s=>{y(s.displayingFeatures)||s.displayingFeatures.length===0||(s.intersectionIncludingBorrowed(t,Ne),s.intersectionIncludingBorrowed(e,Ae),Tt(Ne,Ae)||i.push(s))}),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const s of e)if(!y(s.displayingFeatures))for(const r of s.displayingFeatures){const a=R(r,this.objectIdField);if(t.has(a))continue;t.add(a);const{feature:n}=this.displayingFeatureReferences.get(a);i.removes.push(n),i.adds.push(n)}this._applyChanges()}_updated(){let e=0;this.paused||this.featureTiles.forEach(i=>i.isFetching?++e:0);const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let i=0,s=0,r=0,a=0,n=0;const u=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(h=>{if(++s,h.isFetching&&h.hasPreciseFeatureCount){const _=this._maximumFeaturesForTile(h)*(1-h.emptyFeatureRatio),E=c(h.displayingFeatures)?h.displayingFeatures.length*u:0;n+=_-E}h.needsFetching?++a:h.numFeatures>0&&(++r,i+=h.numFeatures)}),a+=e;let d=0,m=0;i?(m=i,d=Math.min(a*i/r,i)):(m=s,d=a),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",m),this._set("updatingRemaining",d),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=bt(this.featureTiles,t=>t.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=Zi(e),i=a=>1/(1<<Math.max(0,t-a.descriptor.lij[0]));let s=0,r=0;for(const a of e){const n=a.numFeatures;s+=n,r+=n*i(a)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/s),this._farRatio=this.maximumNumberOfFeatures/r,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach(i=>{if(!i.featuresMissing)return;const s=this._maximumFeaturesForTile(i);i.features&&(i.features.length>=s||i.fetchStatus===f.FULL)||(this._cancelFetchTile(i),this._resetFetchTile(i))}),this._setDirty())}_addTile(e){const t=new Qi(e);return this.featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach(i=>{if(!(y(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!Rt(e.descriptor.lij,i.descriptor.lij))){y(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(y(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=wt(e.descriptor.extent)),Ct(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const s of i.displayingFeatures){e.displayingFeatures.push(s);const r=this.displayingFeatureReferences.get(R(s,this.objectIdField));r.ref(r.feature,t),this.numDisplayingFeatureReferences++}}}),e.featureLimit=c(e.displayingFeatures)?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this.featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=f.DONE):e.fetchStatus=f.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;c(t)&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){return e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._getListOfTiles()),e.fetchStatus===f.REFETCHING?f.REFETCH_NEEDED:f.FETCH_NEEDED}async _fetchTile(e,t){const i=this._maximumFeaturesForTile(e);if(i<=0)return Yi(e);const s=this._getMaxRecordCount(e),r=Math.ceil(i/s);if(te(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&r>ne.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const a=this._createQuery(e);if(a.maxRecordCountFactor=Math.ceil(i/s),e.isRefetching&&e.features&&e.features.length>0){const h=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/s);a.maxRecordCountFactor=Math.max(h+1,a.maxRecordCountFactor)}const{features:n,exceededTransferLimit:u,fields:d}=await this._queryFeatures(a,t),m=u?a.maxRecordCountFactor>=ne.MAX_MAX_RECORD_COUNT_FACTOR?f.FULL:f.DONE:f.FULL;return await this._frameTask.schedule(()=>{e.featuresMissing=n.length<e.numFeatures||u;const h=this._removeEmptyFeatures(n);e.setFeatures(n,h,nt(d))},t),this._invalidateCounts(),m}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let i,s=0,r=0,a=0,n=this._maximumFeaturesForTile(e)-a;const u=this._getMaxRecordCount(e);let d=null;for(;;){const m=this._createQuery(e),h=this._setPagingParameters(m,s,n,u),{features:_,exceededTransferLimit:E,fields:K}=await this._queryFeatures(m,t);if(await this._frameTask.schedule(()=>{h&&(s+=ae(m.num)),a+=_.length,r+=this._removeEmptyFeatures(_),e.featuresMissing=s<e.numFeatures||E,i=i?i.concat(_):_,d=Ie(d,K),e.setFeatures(i,r,d)},t),this._invalidateCounts(),this._setDirty(),n=this._maximumFeaturesForTile(e)-a,!h||!E||n<=0)return E?f.DONE:f.FULL}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const s=this.context.tilingScheme.spatialReference;t.geometry=Dt(i,s)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,s){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/s),e.num=Math.min(e.maxRecordCountFactor*s,i)):e.num=Math.min(s),!0)}_getEffectiveTileResolution(e){if(e.descriptor.resolution==null)return null;const t=this.context.viewingMode===ke.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&this.context.geometryType!=="point"}_setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this._getEffectiveTileResolution(t);i!=null&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new St({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):this.context.geometryType==="polyline"&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;){const s=e[i];Ot(s.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!te(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&c(t)&&t>0&&this.context.capabilities.supportsResultType?t:c(i)&&i>0?i:Ji}_useTileQuery(e){return(!te(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,s){e.fetchStatus=e.needsRefetching?f.REFETCHING:f.FETCHING,e.requestController=i;let r=!1;t.then(a=>{e.requestController=null,e.fetchStatus=a}).catch(a=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=f.DONE),S(a)?r=!0:s(a)}).then(()=>{r||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(Mt(()=>{this.handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if(c(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(e.featureLimit===0||!t){const n=c(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],n}const i=e.descriptor.resolution,s=this.changes.updates,r=this.changes.adds,a=Math.min(e.featureLimit,t.length);e.featureLimit=a;for(let n=0;n<a;++n){const u=t[n],d=R(u,this.objectIdField),m=this.displayingFeatureReferences.get(d);if(m){const h=m.ref(u,i);h.oldVersion!==h.newVersion&&(s.removes.push(h.oldVersion),s.adds.push(h.newVersion))}else this.displayingFeatureReferences.set(d,new this.FeatureReferenceClass(u,i)),r.push(u);this.numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,a),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(y(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const s of e.displayingFeatures){const r=R(s,this.objectIdField),a=this.displayingFeatureReferences.get(r);if(!a)continue;const n=a.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,n?n.oldVersion!==n.newVersion&&(n.newVersion==null?(this.displayingFeatureReferences.delete(r),i.push(n.oldVersion)):(t.adds.push(n.newVersion),t.removes.push(n.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,s=Math.min(t.length,i.length);let r=0;for(;r<s;){const a=Math.min(r+ts,s);this.features.addMany(t.slice(r,a)),this.features.removeMany(i.slice(r,a)),r=a}t.length>s&&this.features.addMany(r===0?t:t.slice(r)),i.length>s&&this.features.removeMany(r===0?i:i.slice(r)),t.length=0,i.length=0}_clearTile(e){if(this._hideTile(e),e.features&&c(this.context.memoryCache)){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((e,t)=>e+(t.features?t.features.length:0),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,s=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*s/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function te(e){return e.id==="dummy-tile-full-extent"}function Zi(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}function bs(e){const t=e.capabilities.query;return{supportsMultipleResolutions:Ki(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function Ki(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function Yi(e){return e.setFeatures([],0,null),e.featuresMissing=!1,f.DONE}function nt(e){return y(e)?new Set:new Set(e.map(t=>t.name))}function Ie(e,t){if(y(e)||y(t))return nt(t);const i=new Set;for(const{name:s}of t)e.has(s)&&i.add(s);return i}o([l({constructOnly:!0})],F.prototype,"features",void 0),o([l()],F.prototype,"tileDescriptors",void 0),o([l({value:1/0})],F.prototype,"maximumNumberOfFeatures",null),o([l({value:1})],F.prototype,"memoryFactor",null),o([l({value:1})],F.prototype,"lodFactor",null),o([l()],F.prototype,"useTileCount",null),o([l({readOnly:!0})],F.prototype,"updating",void 0),o([l({readOnly:!0})],F.prototype,"updatingTotal",void 0),o([l({readOnly:!0})],F.prototype,"updatingRemaining",void 0),o([l({readOnly:!0})],F.prototype,"expectedFeatureDiff",void 0),o([l({readOnly:!0})],F.prototype,"memoryForUnusedFeatures",null),o([l({readOnly:!0})],F.prototype,"maximumNumberOfFeaturesExceeded",void 0),o([l({constructOnly:!0})],F.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),o([l({readOnly:!0})],F.prototype,"totalVertices",null),o([l({readOnly:!0})],F.prototype,"totalFeatures",null),o([l()],F.prototype,"filterExtent",null),o([l({constructOnly:!0})],F.prototype,"context",void 0),F=o([q("esri.views.3d.layers.support.FeatureTileFetcher3D")],F);const Ji=2e3,Ne=fe(),Ae=fe(),es=6e5,ts=200,is=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class ss{constructor(t,i,s){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=t,this.view=s,this.tilingScheme=new Pt(i),this.loadedSymbols=is.map(r=>new H(new k({material:{color:[r[0],r[1],r[2],.6]},outline:{color:"black",size:1}}))),this.loadingSymbols=[new H(new k({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new H(new k({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new H(new k({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.update()}update(){this._enabled?(this._synchronizeMaps(this.loadingGraphics,{filter:t=>t.isFetching,symbols:this.loadingSymbols}),this._synchronizeMaps(this.loadedGraphics,{filter:t=>!t.isFetching,symbols:this.loadedSymbols}),this._synchronizeMaps(this.pendingGraphics,{filter:t=>!t.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadingGraphics.clear(),this.loadedGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadedGraphics.clear(),this.pendingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(t){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!t)return;const i=$t.fromExtent(t);this.dataExtentGraphic=new Y({geometry:i,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}_synchronizeMaps(t,i){const s=[];t.forEach((r,a)=>{const n=this.tileFetcher.test.getFeatureTileById(a);n&&i.filter(n)||(this.view.graphics.removeMany(r),s.push(a))}),s.forEach(r=>t.delete(r)),this.tileFetcher.test.forEachFeatureTile(r=>{if(i.filter(r)&&!t.has(r.id)){const[a,n,u]=r.descriptor.lij;this.tilingScheme.ensureMaxLod(a);const d=this.tilingScheme.getExtentGeometry(a,n,u),m=[new Y({geometry:d,symbol:i.symbols[a%i.symbols.length]}),new Y({geometry:d.center,symbol:new It({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new Nt({text:`${a}/${n}/${u}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];t.set(r.id,m),this.view.graphics.addMany(m)}})}}const ie=ge.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let g=class extends At(qe){constructor(e){super(e),this.type="feature-tile-3d",this.watchUpdatingTracking=new Vt,this.serviceDataExtent=null,this.serviceDataCount=b.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new Ge,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=new AbortController}set extent(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void ie.error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("extent",i)}get updating(){return!!(c(this.tileFetcher)&&this.tileFetcher.updating||this.fetchDataInfoPromise!=null||this.mode==="tiles"&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&c(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&c(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&c(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return c(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!c(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return c(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&(e==null?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){var e,t;const i=this.layerView.layer;if(i.type==="feature"&&c(i.infoFor3D))return"snapshot";if(((e=this.layerView.view.qualitySettings)==null||(t=e.graphics3D)==null?void 0:t.snapshotAvailable)===!1||this.serviceDataCount===b.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const s=this.layerView.view,r=s&&s.featureTiles,a=r&&r.tilingScheme;if(i&&i.minScale&&this.serviceDataExtent&&a){const n=this._approximateExtentSizeAtScale(i.minScale,a);if((this.serviceDataExtent.width/n+this.serviceDataExtent.height/n)/2>b.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t=this.mode==="snapshot"&&c(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}_approximateExtentSizeAtScale(e,t){const i=this.layerView.view,s=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),r=t.levels[0];return s*((r.tileSize[0]/(r.scale/e)+r.tileSize[1]/(r.scale/e))/2)}get tileDescriptors(){return this.mode==="snapshot"?new be([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new be}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))),this.watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),N),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&e.type!=="ogc-feature")throw new P("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this._cancelFetchServiceDataInfo(),this.tileFetcher=M(this.tileFetcher),this.handles=M(this.handles),this.tilesHandle=Ut(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,c(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,c(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const e=()=>{c(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){const e=()=>{c(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=Be(()=>{var i;return(i=e.featureTiles)==null?void 0:i.tilingScheme},this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(t),t.then(()=>{const{layerView:i,tileDescriptors:s}=this,r=i.layer,a=new F({context:this.context,filterExtent:this.extent,tileDescriptors:s,features:this.graphics});this.tileFetcher=a,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const n=this.layerView.view.resourceController;n&&this.handles.add(O(()=>n.memoryController.memoryFactor,h=>a.memoryFactor=h,B));const u=this.context.geometryType==="polygon"?"polygonLodFactor":this.context.geometryType==="polyline"?"polylineLodFactor":null;u&&this.handles.add(O(()=>{var h,_,E;return(h=this.layerView.view)==null||(_=h.qualitySettings)==null||(E=_.graphics3D)==null?void 0:E[u]},h=>a.lodFactor=h||1,N));const d=h=>{a.maximumNumberOfFeatures=h,a.useTileCount=this.serviceDataCount>h},m=h=>a.useTileCount=h>this.maximumNumberOfFeatures;r.type!=="ogc-feature"&&this.watchUpdatingTracking.add(()=>r.createQueryVersion,()=>this._dataFilterChanged()),this.watchUpdatingTracking.add(()=>i.availableFields,(h,_)=>this._availableFieldsChanged(_,h)),this.watchUpdatingTracking.add(()=>i.requiredFields,(h,_)=>this._requiredFieldsChanged(_,h)),this.handles.add([r.on("apply-edits",h=>this._applyEdits(h)),this.watch("extent",h=>a.filterExtent=h,!0),this.watch("tileDescriptors",h=>a.tileDescriptors=h,!0),O(()=>this.maximumNumberOfFeatures,d,B),O(()=>this.serviceDataCount,m,B),O(()=>Lt.FEATURE_TILE_FETCH_SHOW_TILES,h=>{h&&a&&!a.debugger?(a.debugger=new ss(a,e.featureTiles.tilingScheme.toTileInfo(),e),a.debugger.update()):!h&&this.tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)},B)]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:ie.warn("Unhandled feature layer mode "+this.mode);case"snapshot":c(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(e){y(this.tileFetcher)||this.tileFetcher.applyEdits(e).then(t=>{t&&(t.deletedFeatures.length||t.updatedFeatures.length||t.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this.lifeCycleAbortController.signal))}).catch(t=>{if(!S(t))throw t})}_availableFieldsChanged(e,t){c(this.tileFetcher)&&Ve(this.tileFetcher.availableFields,t)&&this.refetch()}_requiredFieldsChanged(e,t){c(this.tileFetcher)&&Ve(this.tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){const t=this.layerView.layer,i=t.createQuery();return i.outStatistics=[new qt({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(i.cacheHint=!0),i}_createDataInfoQuery(){const e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}_fullExtentIsAccurate(){const e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return Gt(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(t){S(t)||this._set("serviceDataExtent",Re(this.layerView.fullExtentInLocalViewSpatialReference))}}async _tryUpdateServiceDataExtent(e){const t=this.layerView,i=t.layer,s=i.capabilities.query.supportsExtent,r=Re(t.fullExtentInLocalViewSpatialReference),a=i.fullExtent,n=this._fullExtentIsAccurate(),u=this.serviceDataCount;if(s&&u<=b.MAX_FEATURE_COUNT_FOR_EXTENT&&(!r||!n)&&"queryExtent"in i){const d=this._createDataInfoQuery(),m=await i.queryExtent(d,{timeout:b.QUERY_EXTENT_TIMEOUT,signal:e});this._set("serviceDataExtent",m.extent)}else if(r)this._set("serviceDataExtent",r);else if(c(a)){const d="portalItem"in i?i.portalItem:null,m=await zt(a,t.view.spatialReference,d,e);this._set("serviceDataExtent",m)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t))return void this._set("serviceDataCount",b.NO_SERVICE_DATA_COUNT);const i=await we(t.queryFeatureCount(this._createDataInfoQuery(),{timeout:b.QUERY_STATISTICS_TIMEOUT,signal:e}));if(i.ok===!0)this._set("serviceDataCount",i.value);else{if(S(i.error))throw i.error;this._set("serviceDataCount",b.NO_SERVICE_DATA_COUNT)}}get vertexLimitInfo(){if(y(this.displayFeatureLimit)||y(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:e,maximumTotalNumberOfPrimitives:t}=this.displayFeatureLimit,{primitivesPerCoordinate:i,primitivesPerFeature:s}=e,r=this._get("vertexLimitInfo");return y(r)||r.maximumTotalNumberOfPrimitives!==t||r.primitivesPerCoordinate!==i||r.primitivesPerFeature!==s?{primitivesPerCoordinate:i,primitivesPerFeature:s,maximumTotalNumberOfPrimitives:t}:r}get supportsExceedsLimitQuery(){const e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateVertexLimitExceeded(e,t){const i=this.vertexLimitInfo;if(y(i))return void this._set("vertexLimitExceeded",!1);const s=i.primitivesPerFeature<=0,r=this.minimumNumberOfVerticesForGeometry>1;if(!s&&!r)return void this._set("vertexLimitExceeded",!1);const{primitivesPerFeature:a,primitivesPerCoordinate:n,maximumTotalNumberOfPrimitives:u}=i;let d;a!==0&&c(e)&&await e;const m=this.serviceDataCount,h=m!==b.NO_SERVICE_DATA_COUNT;if(d=Math.ceil(h?(u-m*a)/(n||1):u/(n||1)),r&&(d=Math.min(d,os)),h&&this.minimumNumberOfVerticesForGeometry*m>d)return void this._set("vertexLimitExceeded",!0);if(!this.supportsExceedsLimitQuery)return void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>d);const _=await we(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(d),{timeout:b.QUERY_STATISTICS_TIMEOUT,signal:t}));if(_.ok===!1){if(S(_.error))throw _.error;return void this._set("vertexLimitExceeded",!1)}const E=_.value.features[0];E&&E.attributes?this._set("vertexLimitExceeded",!!E.attributes.exceedslimit):this._set("vertexLimitExceeded",!1)}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this._updateServiceDataCount(t),s=He([i,this._updateVertexLimitExceeded(i,t)]),r=s.then(()=>this._updateServiceDataExtent(t)).catch(a=>{S(a)||ie.error("#fetchServiceDataInfo()",a)}).then(()=>{r===this.fetchDataInfoPromise&&(this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null),e=null});return e&&(this.fetchDataInfoPromise=r),this.fetchDataInfoAbortController=e,s.then(()=>{},()=>{})}_cancelFetchServiceDataInfo(){const e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}get debug(){return{storedFeatures:c(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:c(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:c(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};o([l({readOnly:!0})],g.prototype,"type",void 0),o([l({constructOnly:!0})],g.prototype,"graphics",void 0),o([l({constructOnly:!0})],g.prototype,"layerView",void 0),o([l({constructOnly:!0})],g.prototype,"context",void 0),o([l()],g.prototype,"extent",null),o([l()],g.prototype,"updating",null),o([l({readOnly:!0})],g.prototype,"watchUpdatingTracking",void 0),o([l()],g.prototype,"updatingTotal",null),o([l()],g.prototype,"updatingRemaining",null),o([l()],g.prototype,"expectedFeatureDiff",null),o([l()],g.prototype,"memoryForUnusedFeatures",null),o([l()],g.prototype,"maximumNumberOfFeaturesExceeded",null),o([l({readOnly:!0})],g.prototype,"serviceDataExtent",void 0),o([l({readOnly:!0})],g.prototype,"serviceDataCount",void 0),o([l({readOnly:!0})],g.prototype,"vertexLimitExceeded",void 0),o([l()],g.prototype,"displayFeatureLimit",void 0),o([l({type:Number})],g.prototype,"maximumNumberOfFeatures",null),o([l({readOnly:!0})],g.prototype,"mode",null),o([l({readOnly:!0})],g.prototype,"maxTotalSnapshotVertices",null),o([l({readOnly:!0,dependsOn:["mode"]})],g.prototype,"tileDescriptors",null),o([l()],g.prototype,"tileFetcher",void 0),o([l()],g.prototype,"fetchDataInfoPromise",void 0),o([l({readOnly:!0})],g.prototype,"vertexLimitInfo",null),g=o([q("esri.layers.graphics.controllers.FeatureTileController3D")],g);const rs=1e4,as=12e3,ns=1e4,os=5e6;function Ve(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var b;(function(e){function t(){e.MAX_FEATURE_COUNT_FOR_EXTENT=rs,e.QUERY_STATISTICS_TIMEOUT=as,e.QUERY_EXTENT_TIMEOUT=ns}e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=t})(b||(b={})),b.reset();var T;function ls(e){const t=new je;Ht(t,e);const{mode:i,isAttributeDriven:s}=e;return t.attributes.add(x.POSITION,"vec3"),t.attributes.add(x.UV0,"vec2"),s&&(t.attributes.add(x.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add(new W("radius")),t.vertex.code.add(w`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${x.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${s?w`attributeValue = ${x.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),i===T.KernelDensity?t.fragment.code.add(w`
      void main() {
        float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
        if (radiusRatioSquared > 1.0) {
          discard;
        }

        float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
        float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${s?w` * attributeValue`:""};
        gl_FragColor = vec4(density);
      }
    `):i===T.GaussianBlur&&(t.fragment.uniforms.add(new oe("kernel")),t.fragment.code.add(w`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      vec2 uv = abs(unitCirclePos);
      vec2 uvX = vec2(uv.x, 0.5);
      vec2 uvY = vec2(uv.y, 0.5);
      float intensity = texture2D(kernel, uvX).r * texture2D(kernel, uvY).r${s?w` * attributeValue`:""};
      gl_FragColor = vec4(intensity);
    }
  `)),t}(function(e){e[e.GaussianBlur=0]="GaussianBlur",e[e.KernelDensity=1]="KernelDensity",e[e.COUNT=2]="COUNT"})(T||(T={}));const us=Object.freeze(Object.defineProperty({__proto__:null,get HeatmapMode(){return T},build:ls},Symbol.toStringTag,{value:"Module"}));var Ue;(function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"})(Ue||(Ue={}));class X extends We{constructor(t,i,s){super(t,i,s),this._kernelBlurRadius=1;const{R32F:r,textureFloatLinear:a}=t.rctx.capabilities.textureFloat,n=r!=null;this._kernelTextureChannels=n?1:4,this._floatInterpolationDisabled=!a;const u={target:ue.TEXTURE_2D,pixelFormat:n?$.RED:$.RGBA,internalFormat:n?Xe.R32F:$.RGBA,dataType:he.FLOAT,samplingMode:A.NEAREST,wrapMode:de.CLAMP_TO_EDGE,width:1,height:1};this._kernel=new Ze(t.rctx,u)}initializeProgram(t){const i=X.shader.get().build(this.configuration);return new Ke(t.rctx,i,Ye)}initializePipeline(){return Je({blending:Bt(Ce.ONE,Ce.ONE,jt.ADD),colorWrite:et,depthTest:null,depthWrite:null})}bindPass(t,i){switch(this.program.bindPass(t,i),this.configuration.mode){case T.KernelDensity:this._bindKernelDensityPass(t,i);break;case T.GaussianBlur:this._bindGaussianBlurPass(t,i)}}_bindKernelDensityPass({searchRadius:t,resolutionForScale:i},{camera:s,screenToWorldRatio:r}){i!==0&&(t/=r/i),this.program.setUniform1f("radius",t*s.pixelRatio/s.fullViewport[2])}_bindGaussianBlurPass({searchRadius:t,resolutionForScale:i},{camera:s,screenToWorldRatio:r}){const a=Math.round(t),n=3*(i===0?a:a*i/r);i===0||this._floatInterpolationDisabled?this._kernel.setSamplingMode(A.NEAREST):this._kernel.setSamplingMode(A.LINEAR),this._kernelBlurRadius!==a&&this._recomputeKernel(a),this.program.setUniform1f("radius",2*n*s.pixelRatio/s.fullViewport[2]),this.program.bindTexture("kernel",this._kernel)}_recomputeKernel(t){const i=Ii(Float32Array,t,{channels:this._kernelTextureChannels,halfKernel:!0});this._kernel.resize(i.length/this._kernelTextureChannels,1),this._kernel.setData(i),this._kernelBlurRadius=t}destroy(){this._kernel=V(this._kernel),super.destroy()}}X.shader=new Qe(us,()=>import("./HeatmapDensity.glsl.84f900cb.js"));class ce extends kt{constructor(){super(...arguments),this.mode=T.GaussianBlur,this.isAttributeDriven=!1}}o([le({count:T.COUNT})],ce.prototype,"mode",void 0),o([le()],ce.prototype,"isAttributeDriven",void 0);class hs extends ei{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0,this.isAttributeDriven=!1,this.minDensity=0,this.maxDensity=100,this.fieldTotal=0,this.pixelRatio=1}}class pe extends Wt{constructor(t){super(t,new hs),this._techniqueConfig=new ce}requiresSlot(t,i){return t===Xt.DRAPED_MATERIAL&&i===Zt.MATERIAL}getConfiguration(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(t){return new ds(t)}intersect(){}createBufferWriter(){return new cs(this.parameters.isAttributeDriven?ps:ot)}}class ds extends Kt{constructor(t){super(t)}beginSlot(t){return this.updateParameters(t)}updateParameters(t){return this.ensureTechnique(X,t)}}class cs{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(x.POSITION).length*se}write(t,i,s,r){Yt(i.indices.get(x.POSITION),i.vertexAttributes.get(x.POSITION).data,t.transformation,s.position,r,se);const a=i.indices.get(x.POSITION).length,n=s.uv0;let u=r;for(let m=0;m<a;++m)n.setValues(u++,-1,-1),n.setValues(u++,1,-1),n.setValues(u++,1,1),n.setValues(u++,1,1),n.setValues(u++,-1,1),n.setValues(u++,-1,-1);const d="featureAttribute"in s?s.featureAttribute:null;d&&Jt(i.indices.get(x.FEATUREATTRIBUTE),i.vertexAttributes.get(x.FEATUREATTRIBUTE).data,d,r,se)}}const ot=Qt().vec3f(x.POSITION).vec2f(x.UV0),ps=ot.clone().f32(x.FEATUREATTRIBUTE),se=6;function ms(e){return e instanceof pe}function fs(e){const t=new je;t.include(ti),t.include(ii),t.fragment.uniforms.add(new oe("densityMap")),t.fragment.uniforms.add(new oe("tex")),t.fragment.uniforms.add(new W("densityNormalizer")),t.fragment.uniforms.add(new W("minDensity"));const i=e.mode;return i===T.KernelDensity&&t.fragment.uniforms.add(new W("densityMultiplier")),t.fragment.code.add(w`
    void main() {
      float density = texture2D(densityMap, uv).r${i===T.KernelDensity?w` * densityMultiplier`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),t}const gs=Object.freeze(Object.defineProperty({__proto__:null,build:fs,get HeatmapMode(){return T}},Symbol.toStringTag,{value:"Module"}));class Z extends We{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=Z.shader.get().build({mode:this.configuration.mode});return new Ke(t.rctx,i,Ye)}initializePipeline(){return Je({blending:ri,colorWrite:et,depthTest:null,depthWrite:null})}bindPass(t,i){this.program.bindPass(t,i);const{densityMap:s,colorRamp:r,maxDensity:a,minDensity:n,searchRadius:u}=t;this.program.bindTexture("densityMap",s),this.program.bindTexture("tex",r),this.configuration.mode===T.KernelDensity&&this.program.setUniform1f("densityMultiplier",3/(u*u*Math.PI)),this.program.setUniform1f("densityNormalizer",1/(a-n)),this.program.setUniform1f("minDensity",n)}get primitiveType(){return ai.TRIANGLE_STRIP}}Z.shader=new Qe(gs,()=>import("./Heatmap.glsl.3fec02b3.js"));class lt extends si{constructor(){super(...arguments),this.mode=T.GaussianBlur}}o([le()],lt.prototype,"mode",void 0);let me=class extends ni{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:oi.TEXTURE,depthStencilTarget:li.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:i}=t.colorBufferFloat,{textureFloatLinear:s}=t.textureFloat,r=i!=null,a={target:ue.TEXTURE_2D,pixelFormat:r?$.RED:$.RGBA,internalFormat:r?Xe.R32F:$.RGBA,dataType:he.FLOAT,samplingMode:s?A.LINEAR:A.NEAREST,wrapMode:de.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new ui(this.rctx,e,a),this._quad=hi(this.rctx);const n={target:ue.TEXTURE_2D,pixelFormat:$.RGBA,dataType:he.UNSIGNED_BYTE,samplingMode:A.LINEAR,wrapMode:de.CLAMP_TO_EDGE,width:1,height:1},u=new Ze(this.rctx,n,new Uint8ClampedArray(4));this._colorRamp=u,this._technique=new Z({rctx:this.rctx,viewingMode:ke.Local},new lt),this._heatmapParameters={colorRamp:u,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0,__tagStrict:"NoParameters"}}destroy(){this._technique=di(this._technique),this._densityMap=V(this._densityMap),this._quad=V(this._quad),this._colorRamp=V(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(ys)}render(e,t){const i=this._heatmapDensityMaterialRenderers,s=i.length;if(s<1)return;const r=this.rctx.getBoundFramebufferObject(),a=this.rctx.getViewport(),n=i[0].material.parameters,{pixelRatio:u}=n,d=Math.ceil(a.width*u),m=Math.ceil(a.height*u);this._densityMap.resize(d,m),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,d,m),this.rctx.clear(ci.COLOR_BUFFER_BIT);let h=!1;for(let D=0;D<s;D++){const z=i[D];z.material.shouldRender(e)&&(h=h||z.materialRenderer.render(e.pass,t))}if(this.rctx.bindFramebuffer(r),this.rctx.setViewport(a.x,a.y,a.width,a.height),!h)return;const{searchRadius:_,minDensity:E,maxDensity:K,fieldTotal:ut,colorRampData:U}=n,C=this._heatmapParameters;if(C.searchRadius=_,C.fieldTotal=ut,C.searchRadius=_,C.minDensity=E,C.maxDensity=K,c(U)&&U!==this._colorRampData){const{colorRamp:D}=C,z=D.descriptor.width,ye=U.length/4;ye!==z&&D.resize(ye,1),D.setData(U),this._colorRampData=U}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(C,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,pi(this._quad,"geometry"))}};function ys(e){return ms(e.material)}me=o([q("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],me);const re=ge.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor"),Q=50;let p=class extends mi{constructor(e){super(e),this.type="heatmap",this.filterVisibility={filterChanged(){},dirty:!1},this.preferredUpdatePolicy=tt.ASYNC,this.dataExtent=null,this.drapeSourceType=fi.Features,this._renderGeometries=new Map,this._material=new pe({}),this._materialWithField=new pe({isAttributeDriven:!0}),this._fieldTotal=0,this._drapeSourceRenderer=null}initialize(){this._featureStore=new $i({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{colorBufferFloat:e,textureFloat:t}=this._renderView.capabilities,{floatBufferBlendWorking:i}=this._renderView.renderingContext.driverTest;if(t==null||!t.textureFloat)throw new P("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(e==null||!e.textureFloat)throw new P("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(e==null||!e.floatBlend)throw new P("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!i)throw new P("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,me),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,s=>this._onLoadedFeaturesChange(s),N),this.updatingHandles.addWhen(()=>this._materialParameters,s=>this._forEachMaterial(r=>r.setParameters(s)),N),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},gi),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:s,numeric:r})=>{if(c(s)&&r){let a=0;this._featureStore.forEach(n=>{var u;a+=(u=n.attributes[s])!=null?u:0}),this._fieldTotal=a}else this._fieldTotal=this._featureStore.numFeatures},N),this.handles.add([O(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:s,field:r})=>{var a;s&&!r&&re.warn(`Heatmap renderer field '${s}' for layer '${(a=this.layer.title)!=null?a:this.layer.id}' not found`)}),O(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:s,numeric:r})=>{var a;c(s)&&!r&&re.warn(`Heatmap renderer field '${s.name}' for layer '${(a=this.layer.title)!=null?a:this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),it(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=V(this._material),this._materialWithField=V(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get displayFeatureLimit(){var e,t,i,s,r,a,n;const u=(e=(t=this.owner)==null||(i=t.view)==null||(s=i.resourceController)==null||(r=s.memoryController)==null?void 0:r.memoryFactor)!=null?e:1,d=(a=this.owner)==null||(n=a.view)==null?void 0:n.qualitySettings,m=d?Math.ceil(d.heatmap.maxTotalNumberOfFeatures*u):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:m,maximumTotalNumberOfPrimitives:m*2,maximumNumberOfFeatures:m}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){return!1}get usedMemory(){var e,t,i,s,r;const a=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:n}=(e=this._renderView)==null||(t=e.capabilities)==null?void 0:t.colorBufferFloat,u=n!=null?1:4,d=4,m=(i=Math.ceil(((s=this._overlayRenderer)==null||(r=s.overlays[0])==null?void 0:r.resolution)*this._densityMapPixelRatio))!=null?i:0;return m*m*u*d+a+(c(this._heatmapRenderer)?3*Math.min(this._heatmapRenderer.blurRadius,Q):0)*u*d}get usedMemoryPerFeature(){if(this._featureStore.numFeatures===0)return 0;let e=0;this._featureStore.forEach(s=>e+=yi(s.attributes)),e/=this._featureStore.numFeatures;const t=Di(),i=6;return i*De([0,0,0],t)+i*De([0,0],t)+(this._heatmapRendererFieldIsNumeric?i*t:0)+e}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return ae(this._overlayRenderer.spatialReference)}get _materialParameters(){return ve(I(I({},this._blurRadiusParameters),this._densityParameters),{colorRampData:this._colorRampData,pixelRatio:this._densityMapPixelRatio})}get _densityParameters(){const e=this._heatmapRenderer;return y(e)?null:{minDensity:e.minPixelIntensity,maxDensity:e.maxPixelIntensity,fieldTotal:this._fieldTotal}}get _blurRadiusParameters(){return L(this._heatmapRenderer,({referenceScale:e,blurRadius:t})=>({searchRadius:this._clampSearchRadius(t),resolutionForScale:e===0?0:_i(e,this.view.spatialReference)}))}get _colorRampData(){return L(this._heatmapRenderer,e=>Ni(e.colorStops))}get _densityMapPixelRatio(){var e,t,i,s,r,a,n,u;const d=(e=(t=this.owner)==null||(i=t.view)==null||(s=i.resourceController)==null||(r=s.memoryController)==null?void 0:r.memoryFactor)!=null?e:1;return((a=(n=this.owner)==null||(u=n.view)==null?void 0:u.qualitySettings.heatmap.pixelRatio)!=null?a:1)*Math.sqrt(d)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return this.layer.geometryType==="point"}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return(e==null?void 0:e.type)==="heatmap"?e:null}get _heatmapRendererFieldName(){return L(this._heatmapRenderer,e=>e.field)}get _heatmapRendererField(){return L(this._heatmapRendererFieldName,e=>this.layer.fieldsIndex.get(e))}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return!y(e)&&Fi(e)}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return Le}maskOccludee(){return Le}setObjectIdVisibility(){}async setup(){}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map(n=>R(n,t))),this._featureStore.addMany(e.added.map(n=>new vi(Se(new Oe,n.geometry),n.attributes,L(n.centroid,u=>Se(new Oe,u)),R(n,t))));const i=e.added,s=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,s);const r=xi(s,({uid:n})=>{const u=this._renderGeometries.get(n);return this._renderGeometries.delete(n),u}),a=i.map(n=>{const u=this._pointGraphicToRenderGeometry(n);return this._renderGeometries.set(n.uid,u),u});r.length>0&&this._drapeSourceRenderer.removeGeometries(r,Me.Geometry.REMOVE),a.length>0&&this._drapeSourceRenderer.addGeometries(a,Me.Geometry.ADD),(a.length>0||r.length>0)&&this._renderView.requestRender()}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){const t=this._heatmapRendererFieldName,i=c(t)?this._materialWithField:this._material,s=Si();Ei(e.geometry,s,this._overlaySpatialReference),s[2]=Ti;const r=[[x.POSITION,{data:s,size:s.length}]],a=this._heatmapRendererFieldIsNumeric;var n;c(t)&&r.push([x.FEATUREATTRIBUTE,{data:[a&&(n=e.attributes[t])!=null?n:0],size:1}]);const u=new bi(new Ri(r,null,wi.Point),i,{layerUid:this.layer.uid,graphicUid:e.uid});return Ci(u.boundingSphere,s),u}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(y(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const i=this._heatmapRendererFieldName,s=(r,a)=>{var n;return r+((n=a.attributes[i])!=null?n:0)};return e.reduce(s,0)-t.reduce(s,0)}_clampSearchRadius(e){return e>Q&&re.warnOnce(`SceneView supports a maximum blurRadius of ${Q} for HeatmapRenderer.`),Math.min(e,Q)}};o([l()],p.prototype,"type",void 0),o([l({constructOnly:!0})],p.prototype,"owner",void 0),o([l()],p.prototype,"layer",null),o([l()],p.prototype,"featureStore",null),o([l()],p.prototype,"updating",null),o([l()],p.prototype,"updatingRemaining",null),o([l()],p.prototype,"suspendInfo",null),o([l()],p.prototype,"legendEnabled",null),o([l()],p.prototype,"filterVisibility",void 0),o([l()],p.prototype,"displayFeatureLimit",null),o([l()],p.prototype,"preferredUpdatePolicy",void 0),o([l()],p.prototype,"hasZ",null),o([l()],p.prototype,"hasM",null),o([l()],p.prototype,"dataExtent",void 0),o([l()],p.prototype,"view",null),o([l()],p.prototype,"fullOpacity",null),o([l()],p.prototype,"updatePolicy",null),o([l()],p.prototype,"drapeSourceType",void 0),o([l()],p.prototype,"_featureStore",void 0),o([l()],p.prototype,"_overlayRenderer",null),o([l()],p.prototype,"_overlaySpatialReference",null),o([l()],p.prototype,"_materialParameters",null),o([l()],p.prototype,"_densityParameters",null),o([l()],p.prototype,"_blurRadiusParameters",null),o([l()],p.prototype,"_colorRampData",null),o([l()],p.prototype,"_densityMapPixelRatio",null),o([l()],p.prototype,"_renderGeometries",void 0),o([l()],p.prototype,"_material",void 0),o([l()],p.prototype,"_materialWithField",void 0),o([l()],p.prototype,"_renderView",null),o([l()],p.prototype,"_featuresArePoints",null),o([l()],p.prototype,"_loadedPointGraphics",null),o([l()],p.prototype,"_heatmapRenderer",null),o([l()],p.prototype,"_heatmapRendererFieldName",null),o([l()],p.prototype,"_heatmapRendererField",null),o([l()],p.prototype,"_heatmapRendererFieldIsNumeric",null),o([l()],p.prototype,"_fieldTotal",void 0),o([l()],p.prototype,"_drapeSourceRenderer",void 0),p=o([q("esri.views.3d.layers.support.HeatmapFeatureProcessor")],p);const Le=it(),Rs=e=>{let t=class extends e{constructor(){super(...arguments),this.controller=null,this.updatePolicy=tt.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){const i=this.layer;"isTable"in i&&i.isTable?this.addResolvingPromise(Promise.reject(new P("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:i}))):(this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,s=>this._recreateProcessor(s),N),this.addResolvingPromise((async()=>{const s=await Ai(this);this.fullExtentInLocalViewSpatialReference=s,await this._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,s=>this.processor.preferredUpdatePolicy=s),this.queryEngine=new Mi({layerView:this,priority:ze.FEATURE_QUERY_ENGINE}),this.notifyChange("updating"))}destroy(){this._destroyPendingController(),this.controller=M(this.controller),this._set("processor",M(this.processor)),this.queryEngine=M(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this.pendingController=M(this.pendingController)}get legendEnabled(){var i;return this.canResume()&&((i=this.processor)==null?void 0:i.legendEnabled)}get graphics3DProcessor(){var i;return((i=this.processor)==null?void 0:i.type)==="graphics-3d"?this.processor:null}get heatmapProcessor(){var i;return((i=this.processor)==null?void 0:i.type)==="heatmap"?this.processor:null}getGraphicFromGraphicUid(i){var s;let r=null;return(s=this.loadedGraphics)==null||s.forEach(a=>{a.uid===i&&(r=Oi(a,this.layer))}),r}whenGraphicBounds(i,s){var r;return(r=this.processor)==null?void 0:r.whenGraphicBounds(i,s)}computeAttachmentOrigin(i,s){var r;return(r=this.processor)==null?void 0:r.computeAttachmentOrigin(i,s)}queryFeatures(i,s){return this.queryEngine.executeQuery(this._ensureQuery(i),j(s,"signal"))}queryObjectIds(i,s){return this.queryEngine.executeQueryForIds(this._ensureQuery(i),j(s,"signal"))}queryFeatureCount(i,s){return this.queryEngine.executeQueryForCount(this._ensureQuery(i),j(s,"signal"))}queryExtent(i,s){return this.queryEngine.executeQueryForExtent(this._ensureQuery(i),j(s,"signal"))}_ensureQuery(i){return y(i)?this.createQuery():ne.from(i)}highlight(i){return this.processor.highlight(i,this.layer.objectIdField)}maskOccludee(i){return this.processor.maskOccludee(i)}canResume(){var i;return super.canResume()&&!((i=this.processor)!=null&&i.scaleVisibilitySuspended)}getSuspendInfo(){const i=super.getSuspendInfo();return this.processor?I(I({},i),this.processor.suspendInfo):i}isUpdating(){var i,s,r;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&((i=this.controller)==null||!i.updating)&&(s=this.view)!=null&&(r=s.basemapTerrain)!=null&&r.ready&&!this.processor.updating)}async _initializeController(){const i=this.createController();this.pendingController=i,await i.when(),this._setControllerWhenInitialized(i)}async _setControllerWhenInitialized(i){try{await this.when()}catch{}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await Be(()=>{var s,r;return(s=this.view)==null||(r=s.basemapTerrain)==null?void 0:r.ready}),this.beforeSetController(i),this.pendingController=null,this.controller=i,this.loadedGraphics=i.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(i){if(this.clippingExtent=i,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=i,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new P("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(i){var s,r;const a=(i==null?void 0:i.type)==="heatmap",n=((s=this.processor)==null?void 0:s.type)==="heatmap",u=this.processor;if(u&&a===n)return;const d=a?new p({owner:this}):new Pi({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:m=>this._updateClippingExtent(m)});this._set("processor",d),u==null||u.destroy(),(r=this.queryEngine)==null||r.clear(),this.addResolvingPromise(d.setup())}_getResourceInfo(){var i,s;const r=this.controller instanceof g?this.controller:null;return I({displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:(i=r==null?void 0:r.maximumNumberOfFeatures)!=null?i:-1,totalNumberOfFeatures:(s=r==null?void 0:r.serviceDataCount)!=null?s:-1,nodes:0},this.processor.performanceInfo)}get performanceInfo(){return this._getResourceInfo()}};return o([l()],t.prototype,"loadedGraphics",void 0),o([l()],t.prototype,"suspended",void 0),o([l({readOnly:!0})],t.prototype,"legendEnabled",null),o([l()],t.prototype,"updating",void 0),o([l()],t.prototype,"controller",void 0),o([l()],t.prototype,"processor",void 0),o([l({readOnly:!0})],t.prototype,"updatePolicy",void 0),o([l({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),o([l({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),o([l({readOnly:!0})],t.prototype,"suspendInfo",void 0),o([l()],t.prototype,"graphics3DProcessor",null),o([l()],t.prototype,"heatmapProcessor",null),t=o([q("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};export{bs as A,g as O,fs as d,T as s,ls as u,Rs as v};
