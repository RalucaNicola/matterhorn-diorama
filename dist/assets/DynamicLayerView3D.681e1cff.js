var K=Object.defineProperty,Y=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var N=(t,e,a)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,R=(t,e)=>{for(var a in e||(e={}))J.call(e,a)&&N(t,a,e[a]);if(q)for(var a of q(e))X.call(e,a)&&N(t,a,e[a]);return t},H=(t,e)=>Y(t,Z(e));import{dG as v,dH as E,dI as ee,dJ as te,dK as ae,dL as p,dM as ie,dN as se,dO as re,dP as w,dQ as ne,dR as f,dS as oe,dT as he,dU as le,dV as de,dW as ue,a8 as B,dC as ce,dD as me,i as ge,k as pe,cT as fe,A as b,F as _e,t as U,dX as ye,b4 as D,aC as we,am as F,dY as xe,dZ as Re,dl as Ae,dm as Se,d_ as z,ba as P,d$ as ve,r as V,e0 as M,e1 as Ee,bA as W,a3 as Te,e2 as A,a4 as j,e3 as Ce,e4 as Ie,e5 as be,aK as Pe,e as x,d as S,n as Me}from"./index.25dca4c3.js";import{l as Oe}from"./projectExtentUtils.a4abbe1e.js";import{w as De,_ as $e}from"./ImageMaterialTechnique.c75f682c.js";import{i as Le}from"./RefreshableLayerView.4027030d.js";function Ge(t,e,a){const s=v(t)/E(t),i={width:a,height:a};return s>1.0001?i.height=a/s:s<.9999&&(i.width=a*s),i.width=Math.round(i.width/(v(t)/v(e))),i.height=Math.round(i.height/(E(t)/E(e))),i}function k(t){return ee.createSquareGeometry([[t[0],t[1],-1],[t[2],t[1],-1],[t[2],t[3],-1],[t[0],t[3],-1]])}function qe(t,e){if(!te(t,e))return k(e);const a=[t[1]-e[1],Math.min(t[3],e[3])-Math.max(t[1],e[1]),e[3]-t[3],123456],s=[t[0]-e[0],Math.min(t[2],e[2])-Math.max(t[0],e[0]),e[2]-t[2],123456],i=e[2]-e[0],o=e[3]-e[1],r=s[0]>0&&s[2]>0?3:2,n=a[0]>0&&a[2]>0?3:2,d=(n+1)*(r+1),h=new Float64Array(3*d),u=new Float32Array(2*d),l=new Uint32Array(6*(n*r-1));let T=0,C=0,$=0,c=0,g=0;for(let _=0;_<4;_++){const L=a[_];if(L<=0)continue;let I=0;for(let y=0;y<4;y++){const G=s[y];G<=0||(h[C++]=e[0]+I,h[C++]=e[1]+T,h[C++]=-1,u[$++]=I/i,u[$++]=T/o,y<3&&_<3&&(y!==1||_!==1)&&(l[g++]=c,l[g++]=c+1,l[g++]=c+r+1,l[g++]=c+1,l[g++]=c+r+2,l[g++]=c+r+1),c++,I+=G)}T+=L}const Q=new Uint32Array(l.length);return new ae([[p.POSITION,{size:3,data:h,exclusive:!0}],[p.NORMAL,{size:3,data:Ne,exclusive:!0}],[p.UV0,{size:2,data:u,exclusive:!0}]],[[p.POSITION,l],[p.NORMAL,Q],[p.UV0,l]])}const Ne=[0,0,1];class He extends ie{constructor(e){super(e,new Fe),this.supportsEdges=!0,this.techniqueConfig=new De}getConfiguration(e,a){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.transparencyPassType=a.transparencyPassType,this.techniqueConfig.enableOffset=a.camera.relativeElevation<se,this.techniqueConfig.hasMultipassTerrain=a.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=a.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(e,a,s,i,o,r,n){re(e,a,i,o,r,void 0,n)}requiresSlot(e,a){return e===w.DRAPED_MATERIAL?!0:ne(a)===f.Highlight?e===w.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?w.TRANSPARENT_MATERIAL:w.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:w.OPAQUE_MATERIAL)}createGLMaterial(e){return e.output===f.Color||e.output===f.Alpha||e.output===f.Highlight?new Ue(e):void 0}createBufferWriter(){return new oe(he)}}class Ue extends le{constructor(e){super(R(R({},e),e.material.parameters))}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.passParameters),this.ensureTechnique($e,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output!==f.Color&&this._output!==f.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class Fe extends de{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=ue.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0}}const O=B.getLogger("esri.views.3d.layers.DynamicLayerView3D");let m=class extends Le(ce(me)){constructor(){super(...arguments),this.drapeSourceType=ge.RasterImage,this.updatePolicy=pe.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this._drapeSourceRenderer=null,this.refreshDebounced=fe(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{b(e)||B.getLogger(this.declaredClass).error(e)})},2e3)}initialize(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this),this.handles.add(_e(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))),this.addResolvingPromise(Oe(this).then(t=>this._set("fullExtentInLocalViewSpatialReference",t))),this.updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler()),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(t,e){this._spatialReference=e,t.forEach(a=>{this._overlays[a.index]=a,this._updateImageExtent(a)})}_updateImageExtent(t){const e=this._clippedExtent(t.extent,ze);if(U(e))return;const a=Ge(t.extent,e,t.resolution);let s=t.pixelRatio*this.view.state.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const o=this.layer.imageMaxWidth,r=this.layer.imageMaxHeight;if(a.width>o){const n=o/a.width;a.height=Math.floor(a.height*n),a.width=o,s*=n}if(a.height>r){const n=r/a.height;a.width=Math.floor(a.width*n),a.height=r,s*=n}}const i=this._extents[t.index];i&&ye(i.extent,e)&&this._imageSizeEquals(e,i.imageSize,a)||(this._extents[t.index]={extent:D(e),imageSize:a,pixelRatio:s},this.suspended||this._fetch(t.index).catch(o=>{b(o)||O.error(o)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(){return this._doRefresh()}async _doRefresh(t){if(this.suspended)return;const e=[];for(let a=0;a<this._extents.length;a++)this._extents[a]&&e.push(this._fetch(a,t));await we(e)}canResume(){if(!super.canResume())return!1;const t=this.layer;if(this._isScaleRangeActive()){const{minScale:e,maxScale:a}=t.effectiveScaleRange,s=this.view.scale;if(s<a||e>0&&s>e)return!1}return!0}isUpdating(){return this._images.some(t=>!!t.loadingPromise)}async processResult(t,e,a){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const a=e.extent;if(new F(a[0],a[1],a[2],a[3],this._spatialReference).contains(t))return e}return null}getFetchOptions(){}async redraw(t,e){await xe(this._images,async(a,s)=>{a&&(await t(a,e),await this._createStageObjects(s,a.image,e))})}_imageSizeEquals(t,e,a){if(!this.maximumDataResolution)return!1;const s=v(t)/this.maximumDataResolution.x,i=E(t)/this.maximumDataResolution.y,o=s/e.width,r=i/e.height,n=s/a.width,d=i/a.height,h=Math.abs(o-n),u=Math.abs(r-d),l=Re.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return h<=l&&u<=l}async _fetch(t,e){if(this.suspended)return;const a=this._extents[t],s=a.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:D(s)});const i=this._images[t];i.loadingAbortController&&(i.loadingAbortController.abort(),i.loadingAbortController=null);const o=new F(s[0],s[1],s[2],s[3],this._spatialReference);if(o.width===0||o.height===0)return void this._clearImage(t);const r=new AbortController;i.loadingAbortController=r,Ae(e,()=>r.abort());const n=r.signal,d=this._waitFetchReady(n).then(()=>{const h=H(R({requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio},this.getFetchOptions()),{signal:n}),{height:u,width:l}=a.imageSize;return this.layer.fetchImage(o,l,u,h)}).then(h=>{if(Se(n))throw O.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),z();return this.processResult(i,h)}).then(()=>P(i.renderExtent,s));i.loadingPromise=d,ve(d,()=>{d===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}),this.notifyChange("updating"),await d.then(async()=>{if(n.aborted)throw z();await this._createStageObjects(t,i.image,n),this.notifyChange("updating")}).catch(h=>{throw h&&!b(h)&&O.error(h),this.notifyChange("updating"),h})}_clearImage(t){const e=this._images[t];if(e){V(e.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],M.Geometry.UPDATE),e.renderGeometry=null);const a=this.view._stage;a.remove(e.texture),e.texture=null,a.remove(e.material),e.material=null,e.loadingAbortController&&(e.loadingAbortController.abort(),e.loadingAbortController=null),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,a){const s=this.view._stage,i=this._images[t],o=()=>{s.remove(i.texture),i.texture=null,V(i.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([i.renderGeometry],M.Geometry.UPDATE),i.renderGeometry=null)};if(e){const r=new Ee(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:W.CLAMP_TO_EDGE,t:W.CLAMP_TO_EDGE}});let n;if(await Te(this._images[t===A.INNER?A.OUTER:A.INNER].loadingPromise),j(a),t===A.INNER)n=k(i.renderExtent);else{const d=this._images[0].renderExtent;if(!d)return void o();n=qe(d,i.renderExtent)}o(),s.add(r),await s.loadImmediate(r),i.texture=r,U(i.material)?(i.material=new He({transparent:!0,textureId:r.id}),s.add(i.material)):i.material.setParameters({textureId:r.id}),i.renderGeometry=new Ce(n,i.material),i.renderGeometry.origin=this._overlays[t].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([i.renderGeometry],M.Geometry.UPDATE)}else o(),s.remove(i.material),i.material=null}_isScaleRangeLayer(){return"effectiveScaleRange"in this.layer}_isScaleRangeActive(){const t=this.layer;if(!this._isScaleRangeLayer())return!1;const{minScale:e,maxScale:a}=t.effectiveScaleRange;return Ie(e,a)}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return P(e,t);const a=this.view.basemapTerrain;return a.ready?be(t,a.extent,e):P(e,t)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(t){await Pe(()=>this.view.stationary,t),j(t)}};x([S()],m.prototype,"layer",void 0),x([S()],m.prototype,"suspended",void 0),x([S({readOnly:!0})],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),x([S()],m.prototype,"updating",void 0),m=x([Me("esri.views.3d.layers.DynamicLayerView3D")],m);const Qe=m,ze=D();export{Qe as W};
