var Y=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var V=(e,t,s)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,m=(e,t)=>{for(var s in t||(t={}))X.call(t,s)&&V(e,s,t[s]);if(T)for(var s of T(t))ee.call(t,s)&&V(e,s,t[s]);return e},w=(e,t)=>K(e,W(t));import{cX as A,hv as te,g as re,r as h,fz as se,e as o,d as n,n as F,y as C,t as _,hw as ie,a4 as ae,d_ as oe,hx as ne,hy as J,b as N,a8 as le,hz as ue,eN as ce,hA as de,q as P,U as I,ax as Q,eK as j,eL as Z,hB as L,D as he,b0 as pe,aC as G,hC as B,hD as ye,hE as U,hF as fe,hG as me,hH as k,hI as $,I as O,hJ as ge,dC as Fe,dD as ve,k as q,P as z,aw as we,hK as be,eP as xe}from"./index.25dca4c3.js";import{A as _e,v as qe,O as Ee}from"./FeatureLikeLayerView3D.354fcf9d.js";import{s as Oe}from"./EventedSet.d2302455.js";import{o as H}from"./floorFilterUtils.23f5aee3.js";import{s as M,d as Re}from"./popupUtils.3f7dd2fa.js";import{i as Ce}from"./RefreshableLayerView.4027030d.js";class $e{constructor(t){this._schedule=t,this._handle=new Me(t)}destroy(){this._handle.destroy()}invoke(t,s){return t.buffer&&t.buffer.byteLength!==0?(t.options.sourceSpatialReference&&t.options.sourceSpatialReference instanceof A&&(t.options=w(m({},t.options),{sourceSpatialReference:t.options.sourceSpatialReference.toJSON()})),this._handle.invoke(t,s).then(r=>this._schedule(()=>{if(r.spatialReference=A.fromJSON(r.spatialReference),r.fields)for(let a=0;a<r.fields.length;a++)r.fields[a]=te.fromJSON(r.fields[a]);const i=r.spatialReference;for(const a of r.features)a.uid=re.generateUID(),h(a.geometry)&&(a.geometry.spatialReference=i);return r}))):Promise.resolve(null)}}class Me extends se{constructor(t){super("PBFDecoderWorker","_parseFeatureQuery",t)}getTransferList(t){return[t.buffer]}}let g=class extends C{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,t=e&&e.query;if(t&&t.supportsFormatPBF){var s,r;_(this._decoder)&&(this._decoder=new $e(this.schedule));const i={sourceSpatialReference:(s=(r=this.layer.spatialReference)==null?void 0:r.toJSON())!=null?s:null,applyTransform:!0,maxStringAttributeLength:1024};return(a,u)=>ie(this.layer.parsedUrl,a,"pbf",this._createRequestOptions(u)).then(l=>(ae(u),h(this._decoder)?this._decoder.invoke({buffer:l.data,options:i},u.signal):Promise.reject(oe())))}return(i,a)=>ne(this.layer.parsedUrl,i,this.layer.spatialReference,this._createRequestOptions(a)).then(u=>J(u.data))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=N(this._decoder)}_createRequestOptions(e){return w(m({},e),{query:m(w(m({},this.layer.customParameters),{token:this.layer.apiKey}),e==null?void 0:e.query)})}};o([n({constructOnly:!0})],g.prototype,"layer",void 0),o([n({constructOnly:!0})],g.prototype,"schedule",void 0),o([n({readOnly:!0})],g.prototype,"queryFeaturesDehydrated",null),g=o([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],g);let b=class extends C{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};o([n({constructOnly:!0})],b.prototype,"layer",void 0),o([n({readOnly:!0})],b.prototype,"queryFeaturesDehydrated",null),b=o([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],b);let R=class extends C{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};o([n({constructOnly:!0})],R.prototype,"layer",void 0),R=o([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],R);let x=class extends C{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(J,s=>{if(s&&s.name==="query-features-json:unsupported")return this.layer.queryFeatures(e,t);throw s})}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};function Pe(e,t){return e.type==="feature"&&e.source.type==="feature-layer"?h(e.infoFor3D)?new b({layer:e}):new g({layer:e,schedule:t}):e.type==="feature"&&e.source.type==="memory"||e.type==="csv"||e.type==="geojson"||e.type==="wfs"?new x({layer:e,source:e.source}):e.type==="ogc-feature"?new R({layer:e}):null}o([n({constructOnly:!0})],x.prototype,"layer",void 0),o([n({constructOnly:!0})],x.prototype,"source",void 0),x=o([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],x);class Ie{constructor(t){this._memoryCache=null,this._capabilities=null;const s=t.layerView.layer;this.layerView=t.layerView,this.objectIdField=s.objectIdField,this.globalIdField="globalIdField"in s?s.globalIdField:null,this.returnZ=t.returnZ,this.returnM=t.returnM;const r=this.layerView.view.resourceController;this.query=Pe(s,i=>r.schedule(i)),r&&this.memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(s.uid))}get memoryCacheEnabled(){switch(this.layerView.layer.source.type){case"feature-layer":case"ogc-feature":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=N(this._memoryCache),this.query.destroy()}createQuery(){const t=this.layerView.layer.createQuery();return t.outFields=this.layerView.availableFields,t.returnZ=this.returnZ,t.returnM=this.returnM,t.outSpatialReference=this.tilingScheme.spatialReference,t}get memoryCache(){return this._memoryCache}get viewingMode(){return this.layerView.view.state.viewingMode}get tilingScheme(){return this.layerView.view.featureTiles.tilingScheme}get scheduler(){const t=this.layerView.view.resourceController;return t?t.scheduler:null}get geometryType(){return this.layerView.layer.geometryType}get fullExtent(){return this.layerView.layer.fullExtent}get tileMaxRecordCount(){return this.layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this.layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return h(this._capabilities)||(this._capabilities=_e(this.layerView.layer)),this._capabilities}logFetchError(t,s){t.error("#fetchTile()",this.layerView.layer,s&&s.message?s.message:s)}}const E=le.getLogger("esri.views.layers.FeatureLayerView"),Ne=e=>{let t=class extends e{constructor(...s){super(...s),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([P(()=>{var s;const r=this.layer;return[r==null||(s=r.elevationInfo)==null?void 0:s.featureExpressionInfo,r==null?void 0:r.displayField,r==null?void 0:r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),I),Q(()=>{var s;return(s=this.view)==null?void 0:s.floors},"change",()=>this._handleRequiredFieldsChange()),Q(()=>{const s=this.layer;return s&&"sublayers"in s&&s.sublayers},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:s,layer:{fieldsIndex:r},requiredFields:i}=this;return"outFields"in s&&s.outFields?j(r,[...Z(r,s.outFields),...i]):j(r,i)}set effect(s){L(E,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=s}get effect(){return L(E,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(s){s!==void 0?this._override("featureEffect",s):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(s){E.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(s){throw new Error("missing implementation")}createQuery(){const s={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},r=h(this.filter)?this.filter.createQuery(s):new he(s);if(this.layer.type==="feature"){const i=H(this);h(i)&&(r.where=r.where?`(${r.where}) AND (${i})`:i)}return h(this.timeExtent)&&(r.timeExtent=h(r.timeExtent)?r.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),r}queryFeatures(s,r){throw new Error("missing implementation")}queryObjectIds(s,r){throw new Error("missing implementation")}queryFeatureCount(s,r){throw new Error("missing implementation")}queryExtent(s,r){throw new Error("missing implementation")}async fetchPopupFeatures(s,r){const i=this.validateFetchPopupFeatures(r);if(i)throw i;return this.fetchClientPopupFeatures(r)}_loadArcadeModules(s){if(s.get("expressionInfos.length")||Array.isArray(s.content)&&s.content.some(r=>r.type==="expression"))return pe()}_handleRequiredFieldsChange(){const s=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",s),s.then(()=>{this._updatingRequiredFieldsPromise===s&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const s=this.view.type==="3d",{layer:r,layer:{fieldsIndex:i,objectIdField:a}}=this,u="renderer"in r&&r.renderer,l="orderBy"in r&&r.orderBy,d=r.featureReduction,c=new Set,v=await G([u?u.collectRequiredFields(c,i):null,B(c,r),s?ye(c,r):null,h(this.filter)?U(c,r,this.filter):null,h(this.featureEffect)?U(c,r,this.featureEffect.filter):null,d?fe(c,r,d):null,l?me(c,r,l):null]);if(r.timeInfo&&this.timeExtent&&k(c,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),r.type==="feature"&&r.floorInfo&&k(c,r.fieldsIndex,[r.floorInfo.floorField]),r.type==="subtype-group"){$(c,i,r.subtypeField);const y=r.sublayers.map(S=>{var D;return Promise.all([(D=S.renderer)==null?void 0:D.collectRequiredFields(c,i),B(c,S)])});await G(y)}for(const y of v)y.error&&E.error(y.error);$(c,i,a),s&&"displayField"in r&&r.displayField&&$(c,i,r.displayField);const f=Array.from(c).sort();this._set("requiredFields",f)}validateFetchPopupFeatures(s){if(_(s))return null;for(const r of s.clientGraphics){const i=r.layer;if("popupEnabled"in i&&!i.popupEnabled)return new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i&&!M(i,s))return new O("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i});if(r.isAggregate&&!(i.featureReduction&&"popupTemplate"in i.featureReduction&&i.featureReduction.popupEnabled&&i.featureReduction.popupTemplate))return new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i})}}async fetchClientPopupFeatures(s){const r=h(s)?s.clientGraphics:null;if(!r||r.length===0)return[];const i=new Array(r.length),a=new Map,u=await this.createPopupQuery(s);for(let l=0;l<r.length;l++){const d=r[l];if(d.isAggregate){i[l]=d;continue}const{layer:c}=d;if(!("popupEnabled"in c))continue;const v=Z(this.layer.fieldsIndex,u.outFields),f=M(c,s);if(_(f))continue;const y=await this._loadArcadeModules(f);y&&y.arcadeUtils.hasGeometryOperations(f)||!ge(v,d)?a.set(d.getObjectId(),l):i[l]=d}if(this.layer.type==="stream"||a.size===0)return i.filter(Boolean);u.objectIds=Array.from(a.keys());try{const l=await this.layer.queryFeatures(u);for(const d of l.features)i[a.get(d.getObjectId())]=d}catch{}return i.filter(Boolean)}async createPopupQuery(s){const r=this.layer.createQuery(),i=new Set;let a=!1;const u=h(s)&&s.clientGraphics?s.clientGraphics.map(l=>l.layer):[this.layer];for(const l of u){if(!("popupEnabled"in l))continue;const d=M(l,s);if(_(d))continue;const c=await this._loadArcadeModules(d),v=c&&c.arcadeUtils.hasGeometryOperations(d);a=!(this.layer.geometryType!=="point"&&!v);const f=await Re(this.layer,d);for(const y of f)i.add(y)}if(r.returnGeometry=a,r.returnZ=a,r.returnM=a,r.outFields=Array.from(i),r.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const l=H(this);h(l)&&(r.where=r.where?`(${r.where}) AND (${l})`:l)}return r}canResume(){return!!super.canResume()&&(!h(this.timeExtent)||!this.timeExtent.isEmpty)}};return o([n()],t.prototype,"_updatingRequiredFieldsPromise",void 0),o([n({readOnly:!0})],t.prototype,"availableFields",null),o([n()],t.prototype,"effect",null),o([n({type:ue})],t.prototype,"featureEffect",null),o([n({type:ce})],t.prototype,"filter",void 0),o([n(de)],t.prototype,"timeExtent",void 0),o([n()],t.prototype,"layer",void 0),o([n({type:Number})],t.prototype,"maximumNumberOfFeatures",null),o([n({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),o([n({readOnly:!0})],t.prototype,"requiredFields",void 0),o([n()],t.prototype,"suspended",void 0),o([n()],t.prototype,"view",void 0),t=o([F("esri.views.layers.FeatureLayerView")],t),t};let p=class extends Ce(qe(Ne(Fe(ve)))){constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.updatingHandles.add(()=>this.view.floors,()=>this.processor.filterVisibility.filterChanged()),this.handles.add(P(()=>this._updatingRequiredFieldsPromise,e=>this.updatingHandles.addPromise(e),I))}destroy(){this.updatingHandles.removeAll(),this.handles.removeAll(),this.fetcherContext=N(this.fetcherContext)}get maximumNumberOfFeatures(){var e,t;return(e=(t=this.controller)==null?void 0:t.maximumNumberOfFeatures)!=null?e:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t;let s=0;if((e=this.controller)!=null&&e.updating){const i=this.controller.updatingRemaining,a=Math.max(this.controller.updatingTotal,this._controllerTotal);a>0&&(s=(a-i)/a,this._controllerTotal=a)}let r=0;if((t=this.processor)!=null&&t.updating){const i=this.processor.updatingRemaining,a=Math.max(i,this._processorTotal);a>0&&(r=(a-i)/a,this._processorTotal=a)}return .5*(s+r)}get updatePolicy(){if(!this.controller)return q.ASYNC;switch(this.controller.mode){case"snapshot":{const e=Se[this.layer.geometryType];return e==null||this.controller.serviceDataCount>e?q.ASYNC:q.SYNC}case"tiles":return q.ASYNC}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&e.returnZ!=null?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&e.returnM!=null&&e.returnM}setVisibility(e,t){var s;(s=this.processor)==null||s.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const s=()=>super.queryFeatures(e,t);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(e),s):s()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this.fetcherContext=new Ie({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new Ee({layerView:this,context:this.fetcherContext,graphics:new Oe,extent:this.clippingExtent});return this.updatingHandles.add(()=>e.serviceDataExtent,t=>{this.processor&&(this.processor.dataExtent=t)},z),this.handles.add(P(()=>this.suspended,t=>{t?e.suspend():e.resume()},I)),this.updatingHandles.add(()=>{var t;return(t=this.processor)==null?void 0:t.displayFeatureLimit},t=>e.displayFeatureLimit=t,z),this.handles.add(we(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),e}async doRefresh(e){e&&!this.suspended&&this.controller&&this.controller.refetch(),this.processor.filterVisibility.dirty=!0}getUsedMemory(){var e,t,s,r;return((e=(t=this.processor)==null?void 0:t.usedMemory)!=null?e:0)+((s=(r=this.controller)==null?void 0:r.memoryForUnusedFeatures)!=null?s:0)}getUnloadedMemory(){var e,t,s,r,i;return((e=(t=this.processor)==null?void 0:t.unprocessedMemoryEstimate)!=null?e:0)+((s=((r=this.controller)==null?void 0:r.expectedFeatureDiff)*((i=this.processor)==null?void 0:i.usedMemoryPerFeature))!=null?s:0)}ignoresMemoryFactor(){var e;return(e=this.controller)==null?void 0:e.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const s=await t();if(e&&e.outStatistics||_(this.graphics3DProcessor))return s;const r=this.layer.objectIdField,i=this.graphics3DProcessor.graphics3DGraphicsByObjectID,a=[];for(const u of s.features)if(u.geometry){const l=i.get(u.attributes[r]);l&&(u.geometry=be(l.graphic.geometry),a.push(u))}else a.push(u);return s.features=a,s}async _validateQueryFeaturesMesh(e){if(!e)return;const t=r=>{throw new O("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${r}'`)},s=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of s)e[r]!=null&&t(r);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),h(e.outSpatialReference)&&!e.outSpatialReference.equals(this.view.spatialReference)&&t("outSpatialReference")}get performanceInfo(){var e,t,s,r,i;const a=(e=this.controller)==null?void 0:e.displayFeatureLimit,u=h(a)&&a.averageSymbolComplexity,l=h(u)?`f:${u.primitivesPerFeature},v:${u.primitivesPerCoordinate}`:"n/a",d=w(m({},this._getResourceInfo()),{storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:(t=(s=this.controller)==null?void 0:s.mode)!=null?t:"n/a",symbolComplexity:l,nodes:(r=(i=this.controller)==null?void 0:i.tileDescriptors.length)!=null?r:0});if(this.controller&&d.displayedNumberOfFeatures){const c=this.controller.debug;d.storedFeatures=c.storedFeatures,d.totalVertices=c.totalVertices}return d}get test(){var e;return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:(e=this.controller)==null?void 0:e.graphics}}};o([n()],p.prototype,"layer",void 0),o([n()],p.prototype,"controller",void 0),o([n()],p.prototype,"_controllerTotal",void 0),o([n()],p.prototype,"_processorTotal",void 0),o([n()],p.prototype,"maximumNumberOfFeatures",null),o([n()],p.prototype,"maximumNumberOfFeaturesExceeded",null),o([n(xe)],p.prototype,"updatingProgress",void 0),o([n({readOnly:!0})],p.prototype,"updatingProgressValue",null),o([n({readOnly:!0})],p.prototype,"updatePolicy",null),o([n({readOnly:!0})],p.prototype,"hasZ",null),o([n({readOnly:!0})],p.prototype,"hasM",null),o([n()],p.prototype,"suspendResumeExtentMode",void 0),p=o([F("esri.views.3d.layers.FeatureLayerViewBase3D")],p);const Se={point:5e3,polygon:500,polyline:1e3},Le=p;export{Le as w};
