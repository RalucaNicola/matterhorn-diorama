var C=Object.defineProperty,F=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var h=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var O=(e,r,l)=>r in e?C(e,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[r]=l,f=(e,r)=>{for(var l in r||(r={}))J.call(r,l)&&O(e,l,r[l]);if(h)for(var l of h(r))U.call(r,l)&&O(e,l,r[l]);return e},v=(e,r)=>F(e,N(r));import{r as m,d6 as V,t as L,I as x,d7 as M,d8 as j,cN as k,bF as E}from"./index.165b2b59.js";import{a as A}from"./lazyLayerLoader.620e965d.js";async function W(e){var r;const l=(r=e.properties)==null?void 0:r.customParameters,t=await R(e.url,l),a=v(f({},e.properties),{url:e.url});if(!t.sublayerIds)return t.layerOrTableId!=null&&(a.layerId=t.layerOrTableId,a.sourceJSON=t.sourceJSON),new t.Constructor(a);const n=new(await import("./GroupLayer.69123097.js")).default({title:t.parsedUrl.title});return B(n,t,a),n}function P(e,r){return e?e.find(l=>l.id===r):null}function B(e,r,l){function t(a,n){const o=v(f({},l),{layerId:a,sublayerTitleMode:"service-name"});return m(n)&&(o.sourceJSON=n),new r.Constructor(o)}r.sublayerIds.forEach(a=>{const n=t(a,P(r.sublayerInfos,a));e.add(n)}),r.tableIds.forEach(a=>{const n=t(a,P(r.tableInfos,a));e.tables.add(n)})}async function R(e,r){let l=V(e);if(L(l)&&(l=await q(e,r)),L(l))throw new x("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:t,sublayer:a}=l;let n;const o={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(t){case"MapServer":n=a!=null?"FeatureLayer":K(e,r).then(s=>s?"TileLayer":"MapImageLayer");break;case"ImageServer":n=c(e,{customParameters:r}).then(s=>{const d=s.tileInfo&&s.tileInfo.format;return s.tileInfo?(d==null?void 0:d.toUpperCase())!=="LERC"||s.cacheType&&s.cacheType.toLowerCase()!=="elevation"?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"});break;case"SceneServer":n=c(l.url.path,{customParameters:r}).then(s=>{if(s){if((s==null?void 0:s.layerType)==="Voxel")return"VoxelLayer";if(s!=null&&s.layers&&Array.isArray(s.layers)&&s.layers.length>0){var d;const b={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"},w=(d=s.layers[0])==null?void 0:d.layerType;if(b[w]!=null)return b[w]}}return"SceneLayer"});break;default:n=o[t]}const i={FeatureLayer:!0,SceneLayer:!0},y=t==="FeatureServer",u={parsedUrl:l,Constructor:null,layerOrTableId:y?a:null,sublayerIds:null,tableIds:null},p=await n;if(i[p]&&a==null){const s=await z(e,t,r);if(y&&(u.sublayerInfos=s.layerInfos,u.tableInfos=s.tableInfos),s.layerIds.length+s.tableIds.length!==1)u.sublayerIds=s.layerIds,u.tableIds=s.tableIds;else if(y){var I,S;u.layerOrTableId=(I=s.layerIds[0])!=null?I:s.tableIds[0],u.sourceJSON=(S=s.layerInfos[0])!=null?S:s.tableInfos[0]}}return u.Constructor=await G(p),u}async function q(e,r){var l;const t=await c(e,{customParameters:r});let a=null,n=null;const o=t.type;if(o==="Feature Layer"||o==="Table"?(a="FeatureServer",n=t.id):o==="indexedVector"?a="VectorTileServer":t.hasOwnProperty("mapName")?a="MapServer":t.hasOwnProperty("bandCount")&&t.hasOwnProperty("pixelSizeX")?a="ImageServer":t.hasOwnProperty("maxRecordCount")&&t.hasOwnProperty("allowGeometryUpdates")?a="FeatureServer":t.hasOwnProperty("streamUrls")?a="StreamServer":T(t)?(a="SceneServer",n=t.id):t.hasOwnProperty("layers")&&T((l=t.layers)==null?void 0:l[0])&&(a="SceneServer"),!a)return null;const i=n!=null?M(e):null;return{title:m(i)&&t.name||j(e),serverType:a,sublayer:n,url:{path:m(i)?i.serviceUrl:k(e).path}}}function T(e){return(e==null?void 0:e.hasOwnProperty("store"))&&e.hasOwnProperty("id")&&typeof e.id=="number"}async function z(e,r,l){var t,a;let n,o=!1;if(r==="FeatureServer"){const u=await D(e,{customParameters:l});o=!!u.layersJSON,n=u.layersJSON||u.serviceJSON}else n=await c(e,{customParameters:l});const i=(t=n)==null?void 0:t.layers,y=(a=n)==null?void 0:a.tables;return{layerIds:(i==null?void 0:i.map(u=>u.id).reverse())||[],tableIds:(y==null?void 0:y.map(u=>u.id).reverse())||[],layerInfos:o?i:[],tableInfos:o?y:[]}}function g(e){return!e.type||e.type==="Feature Layer"}async function D(e,r){var l,t;let a=await c(e,r);a=a||{},a.layers=((l=a.layers)==null?void 0:l.filter(g))||[];const n={serviceJSON:a};if(a.currentVersion<10.5)return n;const o=await c(e+"/layers",r);return n.layersJSON={layers:(o==null||(t=o.layers)==null?void 0:t.filter(g))||[],tables:(o==null?void 0:o.tables)||[]},n}async function G(e){return(0,A[e])()}async function K(e,r){return(await c(e,{customParameters:r})).tileInfo}async function c(e,r){return(await E(e,{responseType:"json",query:v(f({f:"json"},r==null?void 0:r.customParameters),{token:r==null?void 0:r.apiKey})})).data}export{D as fetchFeatureService,W as fromUrl};
