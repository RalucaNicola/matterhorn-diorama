import{a8 as N,cT as h,d2 as O,I as i,d3 as R,d4 as F,aC as P,t as q,d5 as D,r as _}from"./index.165b2b59.js";import{r as I}from"./originUtils.0d625f4b.js";import{fetchFeatureService as C}from"./arcgisLayers.120676f0.js";import{o as $}from"./jsonContext.b2c6aeae.js";import{i as g,a as U,c as w,f as d}from"./portalItemUtils.9b39c34e.js";import"./multiOriginJSONSupportUtils.8128aa52.js";import"./lazyLayerLoader.620e965d.js";const j=N.getLogger("esri.layers.FeatureLayer"),p="Feature Service";function u(e,a){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${a}`}function S(e,a){if(a.type!==p)throw new i("feature-layer:portal-item-wrong-type",u(e,`should have portal item of type "${p}"`))}function M(e){var a;return!e.url&&((a=e.source)==null?void 0:a.type)==="memory"}async function T(e){if(await e.load(),M(e))throw new i("feature-layer:save",u(e,"using an in-memory source cannot be saved to a portal item"));if(e.isTable)throw new i("feature-layer:save",u(e,"using a table source cannot be saved to a portal item"))}function Y(e,a){let r=e.messages.filter(({type:t})=>t==="error").map(({name:t,message:n,details:o})=>new i(t,n,o));if(a!=null&&a.ignoreUnsupported&&(r=r.filter(({name:t})=>t!=="layer:unsupported"&&t!=="symbol:unsupported"&&t!=="symbol-layer:unsupported"&&t!=="property:unsupported"&&t!=="url:unsupported")),r.length>0)throw new i("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}async function x(e,a,r){"beforeSave"in e&&typeof e.beforeSave=="function"&&await e.beforeSave();const t=e.write({},a);return Y(a,r),t}function A(e,a){return e.isTable?{layers:[],tables:[a]}:{layers:[a],tables:[]}}function E(e){g(e,d.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((a,r,t)=>t.indexOf(a)===r))}function B(e){const a=e.portalItem;if(!a)throw j.error("save: requires the portalItem property to be set"),new i("feature-layer:portal-item-not-set",u(e,"requires the portalItem property to be set"));if(!a.loaded)throw new i("feature-layer:portal-item-not-loaded",u(e,"cannot be saved to a portal item that does not exist or is inaccessible"));S(e,a)}async function G(e,a){const r=e.portalItem;if(/\/\d+\/?$/.test(r.url))return A(e,a);let t=await r.fetchData("json");return t&&t.layers!=null&&t.tables!=null||(t=await H(e,t)),L(e,a,t),t}async function H(e,a){var r,t;a||(a={}),(r=a).layers||(r.layers=[]),(t=a).tables||(t.tables=[]);const{url:n,layerId:o,customParameters:s,apiKey:c}=e,{serviceJSON:l,layersJSON:f}=await C(n,{customParameters:s,apiKey:c}),y=b(a.layers,l.layers,o),m=b(a.tables,l.tables,o);a.layers=y.itemResources,a.tables=m.itemResources;const J=[...y.added,...m.added],K=f?[...f.layers,...f.tables]:[];return await k(a,J,n,K),a}function b(e,a,r){const t=R(e,a,(o,s)=>o.id===s.id);e=e.filter(o=>!t.removed.some(s=>s.id===o.id));const n=t.added.map(({id:o})=>({id:o}));return n.forEach(({id:o})=>{e.push({id:o})}),{itemResources:e,added:n.filter(({id:o})=>o!==r)}}async function k(e,a,r,t){const n=a.map(({id:o})=>new F({url:r,layerId:o,sourceJSON:t.find(({id:s})=>s===o)}));await P(n.map(o=>o.load())),n.forEach(o=>{const{layerId:s,loaded:c,defaultPopupTemplate:l}=o;!c||q(l)||L(o,{id:s,popupInfo:l.toJSON()},e)})}function L(e,a,r){e.isTable?v(r.tables,a):v(r.layers,a)}function v(e,a){const r=e.findIndex(({id:t})=>t===a.id);r===-1?e.push(a):e[r]=a}function z(e,a){var r,t;let n=D.from(a);return n.id&&(n=n.clone(),n.id=null),(r=n).type!=null||(r.type=p),(t=n).portal!=null||(t.portal=O.getDefault()),S(e,n),n}async function Q(e,a){const{url:r,title:t,fullExtent:n,isTable:o}=e;a.url=r,a.title||(a.title=t),a.extent=null,!o&&_(n)&&(a.extent=await U(n)),w(a,d.METADATA),w(a,d.MULTI_LAYER),g(a,d.SINGLE_LAYER),E(a)}async function V(e,a,r){const t=e.portal;await t._signIn(),await t.user.addItem({item:e,data:a,folder:r==null?void 0:r.folder})}const se=h(W);async function W(e,a){await T(e),B(e);const r=e.portalItem,t=$(r),n=await x(e,t,a),o=await G(e,n);return E(r),await r.update({data:o}),I(t),r}const ie=h(X);async function X(e,a,r){await T(e);const t=z(e,a),n=$(t),o=A(e,await x(e,n,r));return await Q(e,t),await V(t,o,r),e.portalItem=t,I(n),t}export{se as save,ie as saveAs};
