var z=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var G=(r,e,t)=>e in r?z(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,F=(r,e)=>{for(var t in e||(e={}))X.call(e,t)&&G(r,t,e[t]);if(_)for(var t of _(e))Y.call(e,t)&&G(r,t,e[t]);return r},R=(r,e)=>K(r,W(e));import{r as j,cL as ee,iF as te,iG as re,e as o,d as l,iH as se,cY as ie,am as D,cX as oe,cV as ae,n as S,dg as T,iI as ne,g as B,fg as le,gE as pe,iJ as ue,cA as ye,cv as me,iK as ce,iL as de,bF as fe,hA as he,I as M,a6 as U,t as ge,io as we,aC as ve,b0 as xe}from"./index.25dca4c3.js";import{W as be}from"./DynamicLayerView3D.681e1cff.js";import{c as Pe}from"./ExportImageParameters.558cf28f.js";import{l as J}from"./floorFilterUtils.23f5aee3.js";import{s as L}from"./clickToleranceUtils.3a5d6607.js";import{i as Ee}from"./sublayerUtils.5c6ae0ae.js";import{d as Ie,s as $e}from"./popupUtils.3f7dd2fa.js";import{a as Ne}from"./drapedUtils.a3ee7da2.js";import"./projectExtentUtils.a4abbe1e.js";import"./ImageMaterialTechnique.c75f682c.js";import"./RefreshableLayerView.4027030d.js";const Q=r=>r.spatialReference.wkid||JSON.stringify(r.spatialReference);function Oe(r,e){const{dpi:t,gdbVersion:s,geometry:i,geometryPrecision:m,height:p,layerOption:n,mapExtent:a,maxAllowableOffset:d,returnFieldName:P,returnGeometry:E,returnUnformattedValues:c,returnZ:x,spatialReference:f,timeExtent:w,tolerance:I,width:u}=r.toJSON(),{dynamicLayers:b,layerDefs:g,layerIds:h}=Fe(r),$=e&&j(e.geometry)?e.geometry:null,v={geometryPrecision:m,maxAllowableOffset:d,returnFieldName:P,returnGeometry:E,returnUnformattedValues:c,returnZ:x,tolerance:I},O=$&&$.toJSON()||i;if(v.imageDisplay=`${u},${p},${t}`,s&&(v.gdbVersion=s),O&&(delete O.spatialReference,v.geometry=JSON.stringify(O),v.geometryType=ee(O)),f?v.sr=f.wkid||JSON.stringify(f):O&&O.spatialReference?v.sr=Q(O):a&&a.spatialReference&&(v.sr=Q(a)),v.time=w?[w.start,w.end].join(","):null,a){const{xmin:Z,ymin:q,xmax:C,ymax:H}=a;v.mapExtent=`${Z},${q},${C},${H}`}return g&&(v.layerDefs=g),b&&!g&&(v.dynamicLayers=b),v.layers=n==="popup"?"visible":n,h&&!b&&(v.layers+=`:${h.join(",")}`),v}function Fe(r){var e,t;const{mapExtent:s,floors:i,width:m,sublayers:p,layerIds:n,layerOption:a,gdbVersion:d}=r,P=p==null||(e=p.find(u=>u.layer!=null))==null||(t=e.layer)==null?void 0:t.serviceSublayers,E=a==="popup",c={},x={extent:s,width:m,spatialReference:s==null?void 0:s.spatialReference},f=te(x),w=[],I=u=>{const b=f===0,g=u.minScale===0||f<=u.minScale,h=u.maxScale===0||f>=u.maxScale;if(u.visible&&(b||g&&h))if(u.sublayers)u.sublayers.forEach(I);else{if((n==null?void 0:n.includes(u.id))===!1||E&&(!u.popupTemplate||!u.popupEnabled))return;w.unshift(u)}};if(p==null||p.forEach(I),p&&!w.length)c.layerIds=[];else{const u=Ee(w,P,d),b=w.map(g=>{const h=J(i,g);return g.toExportImageJSON(h)});if(u)c.dynamicLayers=JSON.stringify(b);else{if(p){let h=w.map(({id:$})=>$);n&&(h=h.filter($=>n.includes($))),c.layerIds=h}else n!=null&&n.length&&(c.layerIds=n);const g=je(i,w);if(j(g)&&g.length){const h={};for(const $ of g)$.definitionExpression&&(h[$.id]=$.definitionExpression);Object.keys(h).length&&(c.layerDefs=JSON.stringify(h))}}}return c}function je(r,e){const t=!(r==null||!r.length),s=e.filter(i=>i.definitionExpression!=null||t&&i.floorInfo!=null);return s.length?s.map(i=>{const m=J(r,i),p=re(m,i.definitionExpression);return{id:i.id,definitionExpression:p}}):null}var V;let y=V=class extends T{constructor(r){super(r),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(r){return ne(V,r)}};o([l({type:Number,json:{write:!0}})],y.prototype,"dpi",void 0),o([l()],y.prototype,"floors",void 0),o([l({type:String,json:{write:!0}})],y.prototype,"gdbVersion",void 0),o([l({types:se,json:{read:ie,write:!0}})],y.prototype,"geometry",void 0),o([l({type:Number,json:{write:!0}})],y.prototype,"geometryPrecision",void 0),o([l({type:Number,json:{write:!0}})],y.prototype,"height",void 0),o([l({type:[Number],json:{write:!0}})],y.prototype,"layerIds",void 0),o([l({type:["top","visible","all","popup"],json:{write:!0}})],y.prototype,"layerOption",void 0),o([l({type:D,json:{write:!0}})],y.prototype,"mapExtent",void 0),o([l({type:Number,json:{write:!0}})],y.prototype,"maxAllowableOffset",void 0),o([l({type:Boolean,json:{write:!0}})],y.prototype,"returnFieldName",void 0),o([l({type:Boolean,json:{write:!0}})],y.prototype,"returnGeometry",void 0),o([l({type:Boolean,json:{write:!0}})],y.prototype,"returnM",void 0),o([l({type:Boolean,json:{write:!0}})],y.prototype,"returnUnformattedValues",void 0),o([l({type:Boolean,json:{write:!0}})],y.prototype,"returnZ",void 0),o([l({type:oe,json:{write:!0}})],y.prototype,"spatialReference",void 0),o([l()],y.prototype,"sublayers",void 0),o([l({type:ae,json:{write:!0}})],y.prototype,"timeExtent",void 0),o([l({type:Number,json:{write:!0}})],y.prototype,"tolerance",void 0),o([l({type:Number,json:{write:!0}})],y.prototype,"width",void 0),y=V=o([S("esri.rest.support.IdentifyParameters")],y);const k=y;let N=class extends T{constructor(r){super(r),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(r,e){return B.fromJSON({attributes:F({},e.attributes),geometry:F({},e.geometry)})}writeFeature(r,e){if(!r)return;const{attributes:t,geometry:s}=r;t&&(e.attributes=F({},t)),j(s)&&(e.geometry=s.toJSON(),e.geometryType=ue.toJSON(s.type))}};o([l({type:String,json:{write:!0}})],N.prototype,"displayFieldName",void 0),o([l({type:B})],N.prototype,"feature",void 0),o([le("feature",["attributes","geometry"])],N.prototype,"readFeature",null),o([pe("feature")],N.prototype,"writeFeature",null),o([l({type:Number,json:{write:!0}})],N.prototype,"layerId",void 0),o([l({type:String,json:{write:!0}})],N.prototype,"layerName",void 0),N=o([S("esri.rest.support.IdentifyResult")],N);const Se=N;async function Re(r,e,t){const s=(e=Ae(e)).geometry?[e.geometry]:[],i=ye(r);return i.path+="/identify",me(s).then(m=>{const p=Oe(e,{geometry:m&&m[0]}),n=ce(F(R(F({},i.query),{f:"json"}),p)),a=de(n,t);return fe(i.path,a).then(Ve).then(d=>Je(d,e.sublayers))})}function Ve(r){const e=r.data;e.results=e.results||[];const t={results:[]};return t.results=e.results.map(s=>Se.fromJSON(s)),t}function Ae(r){return r=k.from(r)}function Je(r,e){if(e==null||!e.length)return r;const t=new Map;function s(i){t.set(i.id,i),i.sublayers&&i.sublayers.forEach(s)}e.forEach(s);for(const i of r.results)i.feature.sourceLayer=t.get(i.layerId);return r}const _e=r=>{let e=class extends r{initialize(){this.exportImageParameters=new Pe({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,s){var i,m,p;const{layer:n}=this;if(!t)throw new M("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:n});const a=(i=(m=this.layer.capabilities)==null||(p=m.operations)==null?void 0:p.supportsQuery)==null||i;if(!(this.layer.version>=10.5)&&!a)throw new M("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:n});return!a||U("mapimagelayer-popup-identify")?this._fetchPopupFeaturesUsingIdentify(t,s):this._fetchPopupFeaturesUsingQueries(t,s)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}async _fetchPopupFeaturesUsingIdentify(t,s){const i=await this._createIdentifyParameters(t,s);if(ge(i))return[];const{results:m}=await Re(this.layer.parsedUrl,i);return m.map(p=>p.feature)}async _createIdentifyParameters(t,s){var i,m;const{floors:p,spatialReference:n,scale:a}=this.view,d=j(s)?s.event:null,P=await this._collectPopupProviders(this.layer.sublayers,a,s);if(!P.length)return null;await Promise.all(P.map(({sublayer:u})=>u.load().catch(()=>{})));const E=Math.min(U("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((u,b)=>b.renderer?L({renderer:b.renderer,event:d}):u,2)),c=this.createFetchPopupFeaturesQueryGeometry(t,E),x=we(a,n),f=Math.round(c.width/x),w=new D({xmin:c.center.x-x*f,ymin:c.center.y-x*f,xmax:c.center.x+x*f,ymax:c.center.y+x*f,spatialReference:c.spatialReference}),I=((i=this.layer.capabilities)==null||(m=i.operations)==null?void 0:m.supportsQuery)===!1||await new Promise(u=>{let b=!1;Promise.all(P.map(async({popupTemplate:g})=>{if(g){const h=await this._loadArcadeModules(g);if(b)return;h!=null&&h.arcadeUtils.hasGeometryOperations(g)&&(b=!0,u(!0))}})).finally(()=>u(!1))});return new k({floors:p,gdbVersion:this.layer.gdbVersion,geometry:t,height:f,layerOption:"popup",mapExtent:w,maxAllowableOffset:I?0:x,returnGeometry:!0,spatialReference:n,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:E,width:f})}async _fetchPopupFeaturesUsingQueries(t,s){const i=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,s),m=j(s)?s.event:null,p=i.map(async({sublayer:n,popupTemplate:a})=>{await n.load().catch(()=>{});const d=n.createQuery(),P=L({renderer:n.renderer,event:m}),E=this.createFetchPopupFeaturesQueryGeometry(t,P);if(d.geometry=E,d.outFields=await Ie(n,a),"floors"in this.view){var c,x;const w=(c=this.view)==null||(x=c.floors)==null?void 0:x.clone(),I=J(w,n);j(I)&&(d.where=d.where?`(${d.where}) AND (${I})`:I)}const f=await this._loadArcadeModules(a);return f&&f.arcadeUtils.hasGeometryOperations(a)||(d.maxAllowableOffset=E.width/P),(await n.queryFeatures(d)).features});return(await ve(p)).reduce((n,a)=>a.value?[...n,...a.value]:n,[]).filter(n=>n!=null)}async _collectPopupProviders(t,s,i){const m=[],p=async a=>{const d=a.minScale===0||s<=a.minScale,P=a.maxScale===0||s>=a.maxScale;if(a.visible&&d&&P){if(a.sublayers)a.sublayers.forEach(p);else if(a.popupEnabled){const E=$e(a,R(F({},i),{defaultPopupTemplateEnabled:!1}));j(E)&&m.unshift({sublayer:a,popupTemplate:E})}}},n=t.toArray().reverse().map(p);return await Promise.all(n),m}_loadArcadeModules(t){var s;if(((s=t.expressionInfos)==null?void 0:s.length)||Array.isArray(t.content)&&t.content.some(i=>i.type==="expression"))return xe()}};return o([l()],e.prototype,"exportImageParameters",void 0),o([l({readOnly:!0})],e.prototype,"exportImageVersion",null),o([l()],e.prototype,"layer",void 0),o([l()],e.prototype,"suspended",void 0),o([l(he)],e.prototype,"timeExtent",void 0),e=o([S("esri.views.layers.MapImageLayerView")],e),e};let A=class extends _e(be){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(r,e){return Ne(r,e,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};A=o([S("esri.views.3d.layers.MapImageLayerView3D")],A);const He=A;export{He as default};
